'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = function (_ref) {
	var updaterParts = _ref.updaterParts,
	    firebase = _ref.firebase;
	var processActionGroup = updaterParts.processActionGroup;


	return {

		// dipsatches actions straight to the store
		store: function store(instructions) {

			// process actions
			processActionGroup({ actionGroup: instructions.actions });

			return true;
		},

		// makes an api call using axios
		api: function api(instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    serviceOptions = instructions.serviceOptions;

			// process actions for before api call

			processActionGroup({ actionGroup: beforeActions });

			// api call
			return (0, _axios2.default)(serviceOptions || {}).then(function (res) {

				// process success actions
				processActionGroup({ res: res, actionGroup: successActions });

				return res;
			}).catch(function (error) {

				// process failure actions
				processActionGroup({ error: error, actionGroup: failureActions });
			});
		},
		websocket: function websocket(instructions) {
			// @TODO
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    serviceOptions = instructions.serviceOptions;

			// process actions for before api call

			processActionGroup({ actionGroup: beforeActions });

			// socket connection
			var ws = new WebSocket(serviceOptions.url);

			var eventNames = Object.keys(instructions).filter(function (name) {
				return name != 'serviceOptions' && name != 'error';
			});

			// TODO add all possible event names


			// handle non-error events

			var _loop = function _loop() {
				var eventName = eventNames[i];
				var actionGroup = instructions[eventName];

				ws.addEventListener(eventName, function (res) {

					processActionGroup({ res: res, actionGroup: actionGroup });

					// TODO handle sending messages
				});
			};

			for (var i = eventNames.length - 1; i >= 0; i--) {
				_loop();
			}

			// handle error
			ws.addEventListener('error', function (error) {
				processActionGroup({ error: error, actionGroup: failureActions });
			});
		},

		// CRUD for firestore collections and docs
		firestore: !firebase ? undefined : function (instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    serviceOptions = instructions.serviceOptions;

			// process before actions

			processActionGroup({ actionGroup: beforeActions });

			// get firestore service variables
			var refType = serviceOptions.refType,
			    refArray = serviceOptions.refArray,
			    operation = serviceOptions.operation,
			    args = serviceOptions.args;

			// If a docId is supplied, then a doc is referenced, otherwise a collection is referenced
			// TODO may need to handle more complicated references

			return args ? firebase.firestore[refType](refArray.join('/'))[operation](args).then(function (res) {

				// process success actions
				processActionGroup({ res: res, actionGroup: successActions });

				return res;
			}).catch(function (error) {

				// process failure actions
				processActionGroup({ error: error, actionGroup: failureActions });
			}) : firebase.firestore[refType](refArray.join('/'))[operation]().then(function (res) {

				// process success actions
				processActionGroup({ res: res, actionGroup: successActions });

				return res;
			}).catch(function (error) {

				// process failure actions
				processActionGroup({ error: error, actionGroup: failureActions });
			});
		},

		// used to signup, signing, and signout of Firebase Auth
		firebaseAuth: !firebase ? undefined : function (instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    serviceOptions = instructions.serviceOptions;

			// process before actions

			processActionGroup({ actionGroup: beforeActions });

			// get variables for firebase auth operations
			var authMethod = serviceOptions.authMethod,
			    email = serviceOptions.email,
			    password = serviceOptions.password;


			return authMethod == 'signOut' ? firebase.auth[authMethod]().then(function (res) {

				// dispatch success actions
				processActionGroup({ res: res, actionGroup: successActions });

				return res;
			}).catch(function (error) {

				// process failure actions
				processActionGroup({ error: error, actionGroup: failureActions });
			}) : firebase.auth.setPersistence('none') // abstract this to config ? want this to change depending on test env
			.then(function () {
				return firebase.auth[authMethod](email, password).then(function (res) {

					// console.log('res', res)

					// dispatch success actions
					processActionGroup({ res: res, actionGroup: successActions });

					return res;
				});
			}).catch(function (error) {

				// process failure actions
				processActionGroup({ error: error, actionGroup: failureActions });
			});
		},

		firebase: !firebase ? undefined : function (_ref2) {
			var instructions = _ref2.instructions;
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    serviceOptions = instructions.serviceOptions;

			// process before actions

			processActionGroup({ actionGroup: beforeActions });

			var ref = serviceOptions.ref,
			    methodName = serviceOptions.methodName,
			    args = serviceOptions.args;


			firebase.firebase.ref(ref)[methodName](args).then(function (res) {

				// console.log('res from basicFirebase: ', res)

				// process success actions
				processActionGroup({ res: res, actionGroup: successActions });

				return res;
			}).catch(function (error) {

				// process failure actions
				processActionGroup({ error: error, actionGroup: failureActions });
			});
		},

		attachFirebaseListener: !firebase ? undefined : function (_ref3) {
			var instructions = _ref3.instructions;
			var ref = instructions.ref,
			    onChangeActions = instructions.onChangeActions;

			firebase.firebase.ref(ref).on('value', function (res) {

				console.log('change detected in realtime db at ref: ', res, res.val());

				// process success actions
				processActionGroup({ res: res, actionGroup: onChangeActions });
			});
		}
	};
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVVcGRhdGVycy5qcyJdLCJuYW1lcyI6WyJ1cGRhdGVyUGFydHMiLCJmaXJlYmFzZSIsInByb2Nlc3NBY3Rpb25Hcm91cCIsInN0b3JlIiwiaW5zdHJ1Y3Rpb25zIiwiYWN0aW9uR3JvdXAiLCJhY3Rpb25zIiwiYXBpIiwiYmVmb3JlQWN0aW9ucyIsInN1Y2Nlc3NBY3Rpb25zIiwiZmFpbHVyZUFjdGlvbnMiLCJzZXJ2aWNlT3B0aW9ucyIsInRoZW4iLCJyZXMiLCJjYXRjaCIsImVycm9yIiwid2Vic29ja2V0Iiwid3MiLCJXZWJTb2NrZXQiLCJ1cmwiLCJldmVudE5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsImZpbHRlciIsIm5hbWUiLCJldmVudE5hbWUiLCJpIiwiYWRkRXZlbnRMaXN0ZW5lciIsImxlbmd0aCIsImZpcmVzdG9yZSIsInVuZGVmaW5lZCIsInJlZlR5cGUiLCJyZWZBcnJheSIsIm9wZXJhdGlvbiIsImFyZ3MiLCJqb2luIiwiZmlyZWJhc2VBdXRoIiwiYXV0aE1ldGhvZCIsImVtYWlsIiwicGFzc3dvcmQiLCJhdXRoIiwic2V0UGVyc2lzdGVuY2UiLCJyZWYiLCJtZXRob2ROYW1lIiwiYXR0YWNoRmlyZWJhc2VMaXN0ZW5lciIsIm9uQ2hhbmdlQWN0aW9ucyIsIm9uIiwiY29uc29sZSIsImxvZyIsInZhbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUE7Ozs7OztrQkFFZSxnQkFBZ0M7QUFBQSxLQUE3QkEsWUFBNkIsUUFBN0JBLFlBQTZCO0FBQUEsS0FBZkMsUUFBZSxRQUFmQSxRQUFlO0FBQUEsS0FFdENDLGtCQUZzQyxHQUVmRixZQUZlLENBRXRDRSxrQkFGc0M7OztBQUk5QyxRQUFPOztBQUVOO0FBQ0FDLFNBQU8sZUFBQ0MsWUFBRCxFQUFrQjs7QUFFeEI7QUFDQUYsc0JBQW1CLEVBQUVHLGFBQWFELGFBQWFFLE9BQTVCLEVBQW5COztBQUVBLFVBQU8sSUFBUDtBQUVBLEdBVks7O0FBWU47QUFDQUMsT0FBSyxhQUFDSCxZQUFELEVBQWtCO0FBQUEsT0FFZEksYUFGYyxHQUVvREosWUFGcEQsQ0FFZEksYUFGYztBQUFBLE9BRUNDLGNBRkQsR0FFb0RMLFlBRnBELENBRUNLLGNBRkQ7QUFBQSxPQUVpQkMsY0FGakIsR0FFb0ROLFlBRnBELENBRWlCTSxjQUZqQjtBQUFBLE9BRWlDQyxjQUZqQyxHQUVvRFAsWUFGcEQsQ0FFaUNPLGNBRmpDOztBQUl0Qjs7QUFDQVQsc0JBQW1CLEVBQUVHLGFBQWFHLGFBQWYsRUFBbkI7O0FBRUE7QUFDQSxVQUFPLHFCQUFNRyxrQkFBa0IsRUFBeEIsRUFDTEMsSUFESyxDQUNBLFVBQUNDLEdBQUQsRUFBUzs7QUFFZDtBQUNBWCx1QkFBbUIsRUFBRVcsUUFBRixFQUFPUixhQUFhSSxjQUFwQixFQUFuQjs7QUFFQSxXQUFPSSxHQUFQO0FBRUEsSUFSSyxFQVNMQyxLQVRLLENBU0MsVUFBQ0MsS0FBRCxFQUFXOztBQUVqQjtBQUNBYix1QkFBbUIsRUFBRWEsWUFBRixFQUFTVixhQUFhSyxjQUF0QixFQUFuQjtBQUVBLElBZEssQ0FBUDtBQWVBLEdBcENLO0FBcUNOTSxhQUFXLG1CQUFDWixZQUFELEVBQWtCO0FBQzVCO0FBRDRCLE9BRXBCSSxhQUZvQixHQUU4Q0osWUFGOUMsQ0FFcEJJLGFBRm9CO0FBQUEsT0FFTEMsY0FGSyxHQUU4Q0wsWUFGOUMsQ0FFTEssY0FGSztBQUFBLE9BRVdDLGNBRlgsR0FFOENOLFlBRjlDLENBRVdNLGNBRlg7QUFBQSxPQUUyQkMsY0FGM0IsR0FFOENQLFlBRjlDLENBRTJCTyxjQUYzQjs7QUFJNUI7O0FBQ0FULHNCQUFtQixFQUFFRyxhQUFhRyxhQUFmLEVBQW5COztBQUVBO0FBQ0EsT0FBTVMsS0FBSyxJQUFJQyxTQUFKLENBQWNQLGVBQWVRLEdBQTdCLENBQVg7O0FBRUEsT0FBTUMsYUFBNkJDLE9BQU9DLElBQVAsQ0FBWWxCLFlBQVosRUFBMEJtQixNQUExQixDQUFpQyxVQUFDQyxJQUFELEVBQWtCO0FBQ3JGLFdBQU9BLFFBQVEsZ0JBQVIsSUFBNEJBLFFBQVEsT0FBM0M7QUFDQSxJQUZrQyxDQUFuQzs7QUFJQTs7O0FBR0E7O0FBakI0QjtBQW1CM0IsUUFBTUMsWUFBWUwsV0FBV00sQ0FBWCxDQUFsQjtBQUNBLFFBQU1yQixjQUFjRCxhQUFhcUIsU0FBYixDQUFwQjs7QUFFQVIsT0FBR1UsZ0JBQUgsQ0FBb0JGLFNBQXBCLEVBQStCLFVBQUNaLEdBQUQsRUFBUzs7QUFFdkNYLHdCQUFtQixFQUFFVyxRQUFGLEVBQU9SLGFBQWFBLFdBQXBCLEVBQW5COztBQUVBO0FBRUEsS0FORDtBQXRCMkI7O0FBa0I1QixRQUFLLElBQUlxQixJQUFJTixXQUFXUSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DRixLQUFLLENBQXpDLEVBQTRDQSxHQUE1QyxFQUFpRDtBQUFBO0FBV2hEOztBQUVEO0FBQ0FULE1BQUdVLGdCQUFILENBQW9CLE9BQXBCLEVBQTZCLFVBQUNaLEtBQUQsRUFBVztBQUN2Q2IsdUJBQW1CLEVBQUVhLFlBQUYsRUFBU1YsYUFBYUssY0FBdEIsRUFBbkI7QUFDQSxJQUZEO0FBSUEsR0F6RUs7O0FBNEVOO0FBQ0FtQixhQUFXLENBQUM1QixRQUFELEdBQVk2QixTQUFaLEdBQXdCLFVBQUMxQixZQUFELEVBQWtCO0FBQUEsT0FFNUNJLGFBRjRDLEdBRXNCSixZQUZ0QixDQUU1Q0ksYUFGNEM7QUFBQSxPQUU3QkMsY0FGNkIsR0FFc0JMLFlBRnRCLENBRTdCSyxjQUY2QjtBQUFBLE9BRWJDLGNBRmEsR0FFc0JOLFlBRnRCLENBRWJNLGNBRmE7QUFBQSxPQUVHQyxjQUZILEdBRXNCUCxZQUZ0QixDQUVHTyxjQUZIOztBQUlwRDs7QUFDQVQsc0JBQW1CLEVBQUVHLGFBQWFHLGFBQWYsRUFBbkI7O0FBRUE7QUFQb0QsT0FRNUN1QixPQVI0QyxHQVFMcEIsY0FSSyxDQVE1Q29CLE9BUjRDO0FBQUEsT0FRbkNDLFFBUm1DLEdBUUxyQixjQVJLLENBUW5DcUIsUUFSbUM7QUFBQSxPQVF6QkMsU0FSeUIsR0FRTHRCLGNBUkssQ0FRekJzQixTQVJ5QjtBQUFBLE9BUWRDLElBUmMsR0FRTHZCLGNBUkssQ0FRZHVCLElBUmM7O0FBVXBEO0FBQ0E7O0FBQ0EsVUFBT0EsT0FDSmpDLFNBQVM0QixTQUFULENBQW1CRSxPQUFuQixFQUE0QkMsU0FBU0csSUFBVCxDQUFjLEdBQWQsQ0FBNUIsRUFBZ0RGLFNBQWhELEVBQTJEQyxJQUEzRCxFQUNBdEIsSUFEQSxDQUNLLFVBQUNDLEdBQUQsRUFBUzs7QUFFZDtBQUNBWCx1QkFBbUIsRUFBRVcsUUFBRixFQUFPUixhQUFhSSxjQUFwQixFQUFuQjs7QUFFQSxXQUFPSSxHQUFQO0FBQ0EsSUFQQSxFQVFBQyxLQVJBLENBUU0sVUFBQ0MsS0FBRCxFQUFXOztBQUVqQjtBQUNBYix1QkFBbUIsRUFBRWEsWUFBRixFQUFTVixhQUFhSyxjQUF0QixFQUFuQjtBQUVBLElBYkEsQ0FESSxHQWVIVCxTQUFTNEIsU0FBVCxDQUFtQkUsT0FBbkIsRUFBNEJDLFNBQVNHLElBQVQsQ0FBYyxHQUFkLENBQTVCLEVBQWdERixTQUFoRCxJQUNEckIsSUFEQyxDQUNJLFVBQUNDLEdBQUQsRUFBUzs7QUFFZDtBQUNBWCx1QkFBbUIsRUFBRVcsUUFBRixFQUFPUixhQUFhSSxjQUFwQixFQUFuQjs7QUFFQSxXQUFPSSxHQUFQO0FBQ0EsSUFQQyxFQVFEQyxLQVJDLENBUUssVUFBQ0MsS0FBRCxFQUFXOztBQUVqQjtBQUNBYix1QkFBbUIsRUFBRWEsWUFBRixFQUFTVixhQUFhSyxjQUF0QixFQUFuQjtBQUVBLElBYkMsQ0FmSjtBQTZCQSxHQXRISzs7QUF3SE47QUFDQTBCLGdCQUFjLENBQUNuQyxRQUFELEdBQVk2QixTQUFaLEdBQXdCLFVBQUMxQixZQUFELEVBQWtCO0FBQUEsT0FFL0NJLGFBRitDLEdBRW1CSixZQUZuQixDQUUvQ0ksYUFGK0M7QUFBQSxPQUVoQ0MsY0FGZ0MsR0FFbUJMLFlBRm5CLENBRWhDSyxjQUZnQztBQUFBLE9BRWhCQyxjQUZnQixHQUVtQk4sWUFGbkIsQ0FFaEJNLGNBRmdCO0FBQUEsT0FFQUMsY0FGQSxHQUVtQlAsWUFGbkIsQ0FFQU8sY0FGQTs7QUFJdkQ7O0FBQ0FULHNCQUFtQixFQUFFRyxhQUFhRyxhQUFmLEVBQW5COztBQUVBO0FBUHVELE9BUS9DNkIsVUFSK0MsR0FRZjFCLGNBUmUsQ0FRL0MwQixVQVIrQztBQUFBLE9BUW5DQyxLQVJtQyxHQVFmM0IsY0FSZSxDQVFuQzJCLEtBUm1DO0FBQUEsT0FRNUJDLFFBUjRCLEdBUWY1QixjQVJlLENBUTVCNEIsUUFSNEI7OztBQVV2RCxVQUFPRixjQUFjLFNBQWQsR0FFTHBDLFNBQVN1QyxJQUFULENBQWVILFVBQWYsSUFDQXpCLElBREEsQ0FDSyxVQUFDQyxHQUFELEVBQVM7O0FBRWQ7QUFDQVgsdUJBQW1CLEVBQUVXLFFBQUYsRUFBT1IsYUFBYUksY0FBcEIsRUFBbkI7O0FBRUEsV0FBT0ksR0FBUDtBQUVBLElBUkEsRUFTQUMsS0FUQSxDQVNNLFVBQUNDLEtBQUQsRUFBVzs7QUFFakI7QUFDQWIsdUJBQW1CLEVBQUVhLFlBQUYsRUFBU1YsYUFBYUssY0FBdEIsRUFBbkI7QUFFQSxJQWRBLENBRkssR0FpQkxULFNBQVN1QyxJQUFULENBQWNDLGNBQWQsQ0FBNkIsTUFBN0IsRUFBcUM7QUFBckMsSUFDQTdCLElBREEsQ0FDSyxZQUFNO0FBQ1gsV0FBUVgsU0FBU3VDLElBQVQsQ0FBZUgsVUFBZixFQUE2QkMsS0FBN0IsRUFBb0NDLFFBQXBDLEVBQ04zQixJQURNLENBQ0QsVUFBQ0MsR0FBRCxFQUFTOztBQUVkOztBQUVBO0FBQ0FYLHdCQUFtQixFQUFFVyxRQUFGLEVBQU9SLGFBQWFJLGNBQXBCLEVBQW5COztBQUVBLFlBQU9JLEdBQVA7QUFFQSxLQVZNLENBQVI7QUFXQSxJQWJBLEVBY0FDLEtBZEEsQ0FjTSxVQUFDQyxLQUFELEVBQVc7O0FBRWpCO0FBQ0FiLHVCQUFtQixFQUFFYSxZQUFGLEVBQVNWLGFBQWFLLGNBQXRCLEVBQW5CO0FBRUEsSUFuQkEsQ0FqQkY7QUFxQ0EsR0F4S0s7O0FBMEtOVCxZQUFVLENBQUNBLFFBQUQsR0FBWTZCLFNBQVosR0FBd0IsaUJBQXNCO0FBQUEsT0FBbkIxQixZQUFtQixTQUFuQkEsWUFBbUI7QUFBQSxPQUUvQ0ksYUFGK0MsR0FFbUJKLFlBRm5CLENBRS9DSSxhQUYrQztBQUFBLE9BRWhDQyxjQUZnQyxHQUVtQkwsWUFGbkIsQ0FFaENLLGNBRmdDO0FBQUEsT0FFaEJDLGNBRmdCLEdBRW1CTixZQUZuQixDQUVoQk0sY0FGZ0I7QUFBQSxPQUVBQyxjQUZBLEdBRW1CUCxZQUZuQixDQUVBTyxjQUZBOztBQUl2RDs7QUFDQVQsc0JBQW1CLEVBQUVHLGFBQWFHLGFBQWYsRUFBbkI7O0FBTHVELE9BTy9Da0MsR0FQK0MsR0FPckIvQixjQVBxQixDQU8vQytCLEdBUCtDO0FBQUEsT0FPMUNDLFVBUDBDLEdBT3JCaEMsY0FQcUIsQ0FPMUNnQyxVQVAwQztBQUFBLE9BTzlCVCxJQVA4QixHQU9yQnZCLGNBUHFCLENBTzlCdUIsSUFQOEI7OztBQVN2RGpDLFlBQVNBLFFBQVQsQ0FBa0J5QyxHQUFsQixDQUFzQkEsR0FBdEIsRUFBMkJDLFVBQTNCLEVBQXVDVCxJQUF2QyxFQUNFdEIsSUFERixDQUNPLFVBQUNDLEdBQUQsRUFBUzs7QUFFZDs7QUFFQTtBQUNBWCx1QkFBbUIsRUFBRVcsUUFBRixFQUFPUixhQUFhSSxjQUFwQixFQUFuQjs7QUFFQSxXQUFPSSxHQUFQO0FBQ0EsSUFURixFQVVFQyxLQVZGLENBVVEsVUFBQ0MsS0FBRCxFQUFXOztBQUVqQjtBQUNBYix1QkFBbUIsRUFBRWEsWUFBRixFQUFTVixhQUFhSyxjQUF0QixFQUFuQjtBQUVBLElBZkY7QUFnQkEsR0FuTUs7O0FBcU1Oa0MsMEJBQXdCLENBQUMzQyxRQUFELEdBQVk2QixTQUFaLEdBQXdCLGlCQUFzQjtBQUFBLE9BQW5CMUIsWUFBbUIsU0FBbkJBLFlBQW1CO0FBQUEsT0FDN0RzQyxHQUQ2RCxHQUNwQ3RDLFlBRG9DLENBQzdEc0MsR0FENkQ7QUFBQSxPQUN4REcsZUFEd0QsR0FDcEN6QyxZQURvQyxDQUN4RHlDLGVBRHdEOztBQUVyRTVDLFlBQVNBLFFBQVQsQ0FBa0J5QyxHQUFsQixDQUFzQkEsR0FBdEIsRUFBMkJJLEVBQTNCLENBQThCLE9BQTlCLEVBQXVDLFVBQUNqQyxHQUFELEVBQVM7O0FBRS9Da0MsWUFBUUMsR0FBUixDQUFZLHlDQUFaLEVBQXVEbkMsR0FBdkQsRUFBNERBLElBQUlvQyxHQUFKLEVBQTVEOztBQUVBO0FBQ0EvQyx1QkFBbUIsRUFBRVcsUUFBRixFQUFPUixhQUFhd0MsZUFBcEIsRUFBbkI7QUFDQSxJQU5EO0FBT0E7QUE5TUssRUFBUDtBQWdOQSxDIiwiZmlsZSI6ImNyZWF0ZVVwZGF0ZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJ1xuXG5leHBvcnQgZGVmYXVsdCAoeyB1cGRhdGVyUGFydHMsIGZpcmViYXNlIH0pID0+IHtcblxuXHRjb25zdCB7IHByb2Nlc3NBY3Rpb25Hcm91cCB9ID0gdXBkYXRlclBhcnRzXG5cblx0cmV0dXJuIHtcblxuXHRcdC8vIGRpcHNhdGNoZXMgYWN0aW9ucyBzdHJhaWdodCB0byB0aGUgc3RvcmVcblx0XHRzdG9yZTogKGluc3RydWN0aW9ucykgPT4ge1xuXG5cdFx0XHQvLyBwcm9jZXNzIGFjdGlvbnNcblx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGFjdGlvbkdyb3VwOiBpbnN0cnVjdGlvbnMuYWN0aW9ucyB9KVxuXG5cdFx0XHRyZXR1cm4gdHJ1ZVxuXG5cdFx0fSxcblxuXHRcdC8vIG1ha2VzIGFuIGFwaSBjYWxsIHVzaW5nIGF4aW9zXG5cdFx0YXBpOiAoaW5zdHJ1Y3Rpb25zKSA9PiB7XG5cblx0XHRcdGNvbnN0IHsgYmVmb3JlQWN0aW9ucywgc3VjY2Vzc0FjdGlvbnMsIGZhaWx1cmVBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdC8vIHByb2Nlc3MgYWN0aW9ucyBmb3IgYmVmb3JlIGFwaSBjYWxsXG5cdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBhY3Rpb25Hcm91cDogYmVmb3JlQWN0aW9ucyB9KVxuXG5cdFx0XHQvLyBhcGkgY2FsbFxuXHRcdFx0cmV0dXJuIGF4aW9zKHNlcnZpY2VPcHRpb25zIHx8IHt9KVxuXHRcdFx0XHQudGhlbigocmVzKSA9PiB7XG5cblx0XHRcdFx0XHQvLyBwcm9jZXNzIHN1Y2Nlc3MgYWN0aW9uc1xuXHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IHJlcywgYWN0aW9uR3JvdXA6IHN1Y2Nlc3NBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRyZXR1cm4gcmVzXG5cblx0XHRcdFx0fSlcblx0XHRcdFx0LmNhdGNoKChlcnJvcikgPT4ge1xuXG5cdFx0XHRcdFx0Ly8gcHJvY2VzcyBmYWlsdXJlIGFjdGlvbnNcblx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGZhaWx1cmVBY3Rpb25zIH0pXG5cblx0XHRcdFx0fSlcblx0XHR9LFxuXHRcdHdlYnNvY2tldDogKGluc3RydWN0aW9ucykgPT4ge1xuXHRcdFx0Ly8gQFRPRE9cblx0XHRcdGNvbnN0IHsgYmVmb3JlQWN0aW9ucywgc3VjY2Vzc0FjdGlvbnMsIGZhaWx1cmVBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdC8vIHByb2Nlc3MgYWN0aW9ucyBmb3IgYmVmb3JlIGFwaSBjYWxsXG5cdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBhY3Rpb25Hcm91cDogYmVmb3JlQWN0aW9ucyB9KVxuXG5cdFx0XHQvLyBzb2NrZXQgY29ubmVjdGlvblxuXHRcdFx0Y29uc3Qgd3MgPSBuZXcgV2ViU29ja2V0KHNlcnZpY2VPcHRpb25zLnVybClcblxuXHRcdFx0Y29uc3QgZXZlbnROYW1lczogQXJyYXk8c3RyaW5nPiAgPSBPYmplY3Qua2V5cyhpbnN0cnVjdGlvbnMpLmZpbHRlcigobmFtZTogc3RyaW5nKSA9PiB7XG5cdFx0XHRcdHJldHVybiBuYW1lICE9ICdzZXJ2aWNlT3B0aW9ucycgJiYgbmFtZSAhPSAnZXJyb3InXG5cdFx0XHR9KVxuXG5cdFx0XHQvLyBUT0RPIGFkZCBhbGwgcG9zc2libGUgZXZlbnQgbmFtZXNcblxuXG5cdFx0XHQvLyBoYW5kbGUgbm9uLWVycm9yIGV2ZW50c1xuXHRcdFx0Zm9yICh2YXIgaSA9IGV2ZW50TmFtZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcblx0XHRcdFx0Y29uc3QgZXZlbnROYW1lID0gZXZlbnROYW1lc1tpXVxuXHRcdFx0XHRjb25zdCBhY3Rpb25Hcm91cCA9IGluc3RydWN0aW9uc1tldmVudE5hbWVdXG5cblx0XHRcdFx0d3MuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIChyZXMpID0+IHtcblxuXHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IHJlcywgYWN0aW9uR3JvdXA6IGFjdGlvbkdyb3VwIH0pXG5cblx0XHRcdFx0XHQvLyBUT0RPIGhhbmRsZSBzZW5kaW5nIG1lc3NhZ2VzXG5cblx0XHRcdFx0fSlcblx0XHRcdH1cblxuXHRcdFx0Ly8gaGFuZGxlIGVycm9yXG5cdFx0XHR3cy5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChlcnJvcikgPT4ge1xuXHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGZhaWx1cmVBY3Rpb25zIH0pXG5cdFx0XHR9KVxuXG5cdFx0fSxcblxuXG5cdFx0Ly8gQ1JVRCBmb3IgZmlyZXN0b3JlIGNvbGxlY3Rpb25zIGFuZCBkb2NzXG5cdFx0ZmlyZXN0b3JlOiAhZmlyZWJhc2UgPyB1bmRlZmluZWQgOiAoaW5zdHJ1Y3Rpb25zKSA9PiB7XG5cblx0XHRcdGNvbnN0IHsgYmVmb3JlQWN0aW9ucywgc3VjY2Vzc0FjdGlvbnMsIGZhaWx1cmVBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdC8vIHByb2Nlc3MgYmVmb3JlIGFjdGlvbnNcblx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGFjdGlvbkdyb3VwOiBiZWZvcmVBY3Rpb25zIH0pXG5cblx0XHRcdC8vIGdldCBmaXJlc3RvcmUgc2VydmljZSB2YXJpYWJsZXNcblx0XHRcdGNvbnN0IHsgcmVmVHlwZSwgcmVmQXJyYXksIG9wZXJhdGlvbiwgYXJncyB9ID0gc2VydmljZU9wdGlvbnNcblxuXHRcdFx0Ly8gSWYgYSBkb2NJZCBpcyBzdXBwbGllZCwgdGhlbiBhIGRvYyBpcyByZWZlcmVuY2VkLCBvdGhlcndpc2UgYSBjb2xsZWN0aW9uIGlzIHJlZmVyZW5jZWRcblx0XHRcdC8vIFRPRE8gbWF5IG5lZWQgdG8gaGFuZGxlIG1vcmUgY29tcGxpY2F0ZWQgcmVmZXJlbmNlc1xuXHRcdFx0cmV0dXJuIGFyZ3Ncblx0XHRcdFx0PyBmaXJlYmFzZS5maXJlc3RvcmVbcmVmVHlwZV0ocmVmQXJyYXkuam9pbignLycpKVtvcGVyYXRpb25dKGFyZ3MpXG5cdFx0XHRcdFx0LnRoZW4oKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0XHQvLyBwcm9jZXNzIHN1Y2Nlc3MgYWN0aW9uc1xuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LmNhdGNoKChlcnJvcikgPT4ge1xuXG5cdFx0XHRcdFx0XHQvLyBwcm9jZXNzIGZhaWx1cmUgYWN0aW9uc1xuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0OiAgZmlyZWJhc2UuZmlyZXN0b3JlW3JlZlR5cGVdKHJlZkFycmF5LmpvaW4oJy8nKSlbb3BlcmF0aW9uXSgpXG5cdFx0XHRcdFx0LnRoZW4oKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0XHQvLyBwcm9jZXNzIHN1Y2Nlc3MgYWN0aW9uc1xuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LmNhdGNoKChlcnJvcikgPT4ge1xuXG5cdFx0XHRcdFx0XHQvLyBwcm9jZXNzIGZhaWx1cmUgYWN0aW9uc1xuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0fSlcblx0XHR9LFxuXG5cdFx0Ly8gdXNlZCB0byBzaWdudXAsIHNpZ25pbmcsIGFuZCBzaWdub3V0IG9mIEZpcmViYXNlIEF1dGhcblx0XHRmaXJlYmFzZUF1dGg6ICFmaXJlYmFzZSA/IHVuZGVmaW5lZCA6IChpbnN0cnVjdGlvbnMpID0+IHtcblxuXHRcdFx0Y29uc3QgeyBiZWZvcmVBY3Rpb25zLCBzdWNjZXNzQWN0aW9ucywgZmFpbHVyZUFjdGlvbnMsIHNlcnZpY2VPcHRpb25zIH0gPSBpbnN0cnVjdGlvbnNcblxuXHRcdFx0Ly8gcHJvY2VzcyBiZWZvcmUgYWN0aW9uc1xuXHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgYWN0aW9uR3JvdXA6IGJlZm9yZUFjdGlvbnMgfSlcblxuXHRcdFx0Ly8gZ2V0IHZhcmlhYmxlcyBmb3IgZmlyZWJhc2UgYXV0aCBvcGVyYXRpb25zXG5cdFx0XHRjb25zdCB7IGF1dGhNZXRob2QsIGVtYWlsLCBwYXNzd29yZCB9ID0gc2VydmljZU9wdGlvbnNcblxuXHRcdFx0cmV0dXJuIGF1dGhNZXRob2QgPT0gJ3NpZ25PdXQnXG5cblx0XHRcdD8gZmlyZWJhc2UuYXV0aFsgYXV0aE1ldGhvZCBdKClcblx0XHRcdFx0LnRoZW4oKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0Ly8gZGlzcGF0Y2ggc3VjY2VzcyBhY3Rpb25zXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdHJldHVybiByZXNcblxuXHRcdFx0XHR9KVxuXHRcdFx0XHQuY2F0Y2goKGVycm9yKSA9PiB7XG5cblx0XHRcdFx0XHQvLyBwcm9jZXNzIGZhaWx1cmUgYWN0aW9uc1xuXHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogZmFpbHVyZUFjdGlvbnMgfSlcblxuXHRcdFx0XHR9KVxuXHRcdFx0OiBmaXJlYmFzZS5hdXRoLnNldFBlcnNpc3RlbmNlKCdub25lJykgLy8gYWJzdHJhY3QgdGhpcyB0byBjb25maWcgPyB3YW50IHRoaXMgdG8gY2hhbmdlIGRlcGVuZGluZyBvbiB0ZXN0IGVudlxuXHRcdFx0XHQudGhlbigoKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuICBmaXJlYmFzZS5hdXRoWyBhdXRoTWV0aG9kIF0oIGVtYWlsLCBwYXNzd29yZCApXG5cdFx0XHRcdFx0XHQudGhlbigocmVzKSA9PiB7XG5cblx0XHRcdFx0XHRcdFx0Ly8gY29uc29sZS5sb2coJ3JlcycsIHJlcylcblxuXHRcdFx0XHRcdFx0XHQvLyBkaXNwYXRjaCBzdWNjZXNzIGFjdGlvbnNcblx0XHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gcmVzXG5cblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5jYXRjaCgoZXJyb3IpID0+IHtcblxuXHRcdFx0XHRcdC8vIHByb2Nlc3MgZmFpbHVyZSBhY3Rpb25zXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdH0pXG5cdFx0fSxcblxuXHRcdGZpcmViYXNlOiAhZmlyZWJhc2UgPyB1bmRlZmluZWQgOiAoeyBpbnN0cnVjdGlvbnMgfSkgPT4ge1xuXG5cdFx0XHRjb25zdCB7IGJlZm9yZUFjdGlvbnMsIHN1Y2Nlc3NBY3Rpb25zLCBmYWlsdXJlQWN0aW9ucywgc2VydmljZU9wdGlvbnMgfSA9IGluc3RydWN0aW9uc1xuXG5cdFx0XHQvLyBwcm9jZXNzIGJlZm9yZSBhY3Rpb25zXG5cdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBhY3Rpb25Hcm91cDogYmVmb3JlQWN0aW9ucyB9KVxuXG5cdFx0XHRjb25zdCB7IHJlZiwgbWV0aG9kTmFtZSwgYXJncyB9ID0gc2VydmljZU9wdGlvbnNcblxuXHRcdFx0ZmlyZWJhc2UuZmlyZWJhc2UucmVmKHJlZilbbWV0aG9kTmFtZV0oYXJncylcblx0XHRcdFx0LnRoZW4oKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0Ly8gY29uc29sZS5sb2coJ3JlcyBmcm9tIGJhc2ljRmlyZWJhc2U6ICcsIHJlcylcblxuXHRcdFx0XHRcdC8vIHByb2Nlc3Mgc3VjY2VzcyBhY3Rpb25zXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0fSlcblx0XHRcdFx0LmNhdGNoKChlcnJvcikgPT4ge1xuXG5cdFx0XHRcdFx0Ly8gcHJvY2VzcyBmYWlsdXJlIGFjdGlvbnNcblx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGZhaWx1cmVBY3Rpb25zIH0pXG5cblx0XHRcdFx0fSlcblx0XHR9LFxuXG5cdFx0YXR0YWNoRmlyZWJhc2VMaXN0ZW5lcjogIWZpcmViYXNlID8gdW5kZWZpbmVkIDogKHsgaW5zdHJ1Y3Rpb25zIH0pID0+IHtcblx0XHRcdGNvbnN0IHsgcmVmLCBvbkNoYW5nZUFjdGlvbnMgfSA9IGluc3RydWN0aW9uc1xuXHRcdFx0ZmlyZWJhc2UuZmlyZWJhc2UucmVmKHJlZikub24oJ3ZhbHVlJywgKHJlcykgPT4ge1xuXG5cdFx0XHRcdGNvbnNvbGUubG9nKCdjaGFuZ2UgZGV0ZWN0ZWQgaW4gcmVhbHRpbWUgZGIgYXQgcmVmOiAnLCByZXMsIHJlcy52YWwoKSlcblxuXHRcdFx0XHQvLyBwcm9jZXNzIHN1Y2Nlc3MgYWN0aW9uc1xuXHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBvbkNoYW5nZUFjdGlvbnMgfSlcblx0XHRcdH0pXG5cdFx0fSxcblx0fVxufVxuIl19
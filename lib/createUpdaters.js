'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = function (_ref) {
	var updaterParts = _ref.updaterParts,
	    firebase = _ref.firebase;
	var processActionGroup = updaterParts.processActionGroup;


	return {

		store: function store(instructions) {

			processActionGroup({ actionGroup: instructions.actions });

			return true;
		},

		api: function api(instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    afterActions = instructions.afterActions,
			    serviceOptions = instructions.serviceOptions;


			processActionGroup({ actionGroup: beforeActions });

			return (0, _axios2.default)(serviceOptions || {}).then(function (res) {

				processActionGroup({ res: res, actionGroup: successActions });

				processActionGroup({ res: res, actionGroup: afterActions });

				return res;
			}).catch(function (error) {

				processActionGroup({ error: error, actionGroup: failureActions });

				processActionGroup({ error: error, actionGroup: afterActions });
			});
		},

		websocket: function websocket(instructions) {
			// @TODO
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    afterActions = instructions.afterActions,
			    serviceOptions = instructions.serviceOptions;


			processActionGroup({ actionGroup: beforeActions });

			// socket connection
			var ws = new WebSocket(serviceOptions.url);

			var eventNames = Object.keys(instructions).filter(function (name) {
				return name != 'serviceOptions' && name != 'error';
			});

			// TODO add all possible event names


			// handle non-error events

			var _loop = function _loop(i) {
				var eventName = eventNames[i];
				var actionGroup = instructions[eventName];

				ws.addEventListener(eventName, function (res) {

					processActionGroup({ res: res, actionGroup: actionGroup });

					// TODO handle sending messages
				});
			};

			for (var i = eventNames.length - 1; i >= 0; i--) {
				_loop(i);
			}

			// handle error
			ws.addEventListener('error', function (error) {

				processActionGroup({ error: error, actionGroup: failureActions });
			});
		},

		// CRUD for firestore collections and docs
		firestore: !firebase ? undefined : function (instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    afterActions = instructions.afterActions,
			    serviceOptions = instructions.serviceOptions;


			processActionGroup({ actionGroup: beforeActions });

			var refType = serviceOptions.refType,
			    refArray = serviceOptions.refArray,
			    operation = serviceOptions.operation,
			    args = serviceOptions.args;

			// If a docId is supplied, then a doc is referenced, otherwise a collection is referenced
			// TODO may need to handle more complicated references

			return args ? firebase.firestore[refType](refArray.join('/'))[operation](args).then(function (res) {

				processActionGroup({ res: res, actionGroup: successActions });

				processActionGroup({ res: res, actionGroup: afterActions });

				return res;
			}).catch(function (error) {

				processActionGroup({ error: error, actionGroup: failureActions });

				processActionGroup({ error: error, actionGroup: afterActions });
			}) : firebase.firestore[refType](refArray.join('/'))[operation]().then(function (res) {

				processActionGroup({ res: res, actionGroup: successActions });

				processActionGroup({ res: res, actionGroup: afterActions });

				return res;
			}).catch(function (error) {

				processActionGroup({ error: error, actionGroup: failureActions });

				processActionGroup({ error: error, actionGroup: afterActions });
			});
		},

		// used to signup, signing, and signout of Firebase Auth
		firebaseAuth: !firebase ? undefined : function (instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    afterActions = instructions.afterActions,
			    serviceOptions = instructions.serviceOptions;


			processActionGroup({ actionGroup: beforeActions });

			var authMethod = serviceOptions.authMethod,
			    email = serviceOptions.email,
			    password = serviceOptions.password,
			    persistenceType = serviceOptions.persistenceType;


			switch (authMethod) {

				case 'signInWithEmailAndPassword':
					return firebase.auth.setPersistence(persistenceType || 'none').then(function () {
						return firebase.auth.signInWithEmailAndPassword(email, password).then(function (res) {

							processActionGroup({ res: res, actionGroup: successActions });

							processActionGroup({ res: res, actionGroup: afterActions });

							return res;
						});
					}).catch(function (error) {

						processActionGroup({ error: error, actionGroup: failureActions });

						processActionGroup({ error: error, actionGroup: afterActions });
					});

				case 'signOut':
					return firebase.auth.signOut().then(function (res) {

						processActionGroup({ res: res, actionGroup: successActions });

						processActionGroup({ res: res, actionGroup: afterActions });
					}).catch(function (error) {

						processActionGroup({ error: error, actionGroup: failureActions });

						processActionGroup({ error: error, actionGroup: afterActions });
					});

				case 'createUserWithEmailAndPassword':
					return firebase.auth.createUserWithEmailAndPassword(email, password).then(function (res) {

						processActionGroup({ res: res, actionGroup: successActions });

						processActionGroup({ res: res, actionGroup: afterActions });

						return res;
					}).catch(function (error) {

						processActionGroup({ error: error, actionGroup: failureActions });

						processActionGroup({ error: error, actionGroup: afterActions });
					});

				// use this to log user into redux with persistent firebase auth
				case 'onAuthStateChanged':
					return firebase.auth.onAuthStateChanged(function (res) {
						// this will be the user object

						processActionGroup({ res: res, actionGroup: actions || successActions });

						processActionGroup({ res: res, actionGroup: afterActions });
					});

				// TODO: social auth

				default:
					return;
			}
		},

		// use for realtime firebase CRUD
		firebase: !firebase ? undefined : function (instructions) {
			var beforeActions = instructions.beforeActions,
			    successActions = instructions.successActions,
			    failureActions = instructions.failureActions,
			    afterActions = instructions.afterActions,
			    serviceOptions = instructions.serviceOptions;

			// process before actions

			processActionGroup({ actionGroup: beforeActions });

			var ref = serviceOptions.ref,
			    methodName = serviceOptions.methodName,
			    args = serviceOptions.args;


			return args ? firebase.firebase.ref(ref)[methodName](args).then(function (res) {

				processActionGroup({ res: res, actionGroup: successActions });

				processActionGroup({ res: res, actionGroup: afterActions });

				return res;
			}).catch(function (error) {

				processActionGroup({ error: error, actionGroup: failureActions });

				processActionGroup({ error: error, actionGroup: afterActions });
			}) : firebase.firebase.ref(ref)[methodName]().then(function (res) {

				processActionGroup({ res: res, actionGroup: successActions });

				processActionGroup({ res: res, actionGroup: afterActions });

				return res;
			}).catch(function (error) {

				processActionGroup({ error: error, actionGroup: failureActions });

				processActionGroup({ error: error, actionGroup: afterActions });
			});
		},

		attachFirebaseListener: !firebase ? undefined : function (instructions) {
			var onChangeActions = instructions.onChangeActions,
			    serviceOptions = instructions.serviceOptions;
			var ref = serviceOptions.ref,
			    eventMethod = serviceOptions.eventMethod;


			firebase.firebase.ref(ref).on(eventMethod, function (res) {

				console.log('change detected in realtime db at ref: ', res, res.val());

				processActionGroup({ res: res, actionGroup: onChangeActions });
			});
		}

		// firebaseStorage: !firebase ? undefined : ( instructions ) => {
		//
		// 	const { successActions, failureActions, serviceOptions, afterActions } = instructions
		//
		// 	const { ref, methodName, file, metadata } = serviceOptions
		//
		// 	const uploadTask = firebase.storage.ref(ref)[methodName](file)
		//
		//
		//
		// 	return uploadTask
		// 		.then((res) => {
		//
		// 			processActionGroup({ res, actionGroup: successActions })
		//
		// 			processActionGroup({ res, actionGroup: afterActions })
		//
		// 		})
		// 		.catch((error) => {
		//
		// 			processActionGroup({ error, actionGroup: failureActions })
		//
		// 			processActionGroup({ error, actionGroup: afterActions })
		//
		// 		})
		// }
	};
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVVcGRhdGVycy5qcyJdLCJuYW1lcyI6WyJ1cGRhdGVyUGFydHMiLCJmaXJlYmFzZSIsInByb2Nlc3NBY3Rpb25Hcm91cCIsInN0b3JlIiwiaW5zdHJ1Y3Rpb25zIiwiYWN0aW9uR3JvdXAiLCJhY3Rpb25zIiwiYXBpIiwiYmVmb3JlQWN0aW9ucyIsInN1Y2Nlc3NBY3Rpb25zIiwiZmFpbHVyZUFjdGlvbnMiLCJhZnRlckFjdGlvbnMiLCJzZXJ2aWNlT3B0aW9ucyIsInRoZW4iLCJyZXMiLCJjYXRjaCIsImVycm9yIiwid2Vic29ja2V0Iiwid3MiLCJXZWJTb2NrZXQiLCJ1cmwiLCJldmVudE5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsImZpbHRlciIsIm5hbWUiLCJpIiwiZXZlbnROYW1lIiwiYWRkRXZlbnRMaXN0ZW5lciIsImxlbmd0aCIsImZpcmVzdG9yZSIsInVuZGVmaW5lZCIsInJlZlR5cGUiLCJyZWZBcnJheSIsIm9wZXJhdGlvbiIsImFyZ3MiLCJqb2luIiwiZmlyZWJhc2VBdXRoIiwiYXV0aE1ldGhvZCIsImVtYWlsIiwicGFzc3dvcmQiLCJwZXJzaXN0ZW5jZVR5cGUiLCJhdXRoIiwic2V0UGVyc2lzdGVuY2UiLCJzaWduSW5XaXRoRW1haWxBbmRQYXNzd29yZCIsInNpZ25PdXQiLCJjcmVhdGVVc2VyV2l0aEVtYWlsQW5kUGFzc3dvcmQiLCJvbkF1dGhTdGF0ZUNoYW5nZWQiLCJyZWYiLCJtZXRob2ROYW1lIiwiYXR0YWNoRmlyZWJhc2VMaXN0ZW5lciIsIm9uQ2hhbmdlQWN0aW9ucyIsImV2ZW50TWV0aG9kIiwib24iLCJjb25zb2xlIiwibG9nIiwidmFsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQTs7Ozs7O2tCQUVlLGdCQUFnQztBQUFBLEtBQTdCQSxZQUE2QixRQUE3QkEsWUFBNkI7QUFBQSxLQUFmQyxRQUFlLFFBQWZBLFFBQWU7QUFBQSxLQUV0Q0Msa0JBRnNDLEdBRWZGLFlBRmUsQ0FFdENFLGtCQUZzQzs7O0FBSTlDLFFBQU87O0FBRU5DLFNBQU8sZUFBQ0MsWUFBRCxFQUFrQjs7QUFFeEJGLHNCQUFtQixFQUFFRyxhQUFhRCxhQUFhRSxPQUE1QixFQUFuQjs7QUFFQSxVQUFPLElBQVA7QUFFQSxHQVJLOztBQVVOQyxPQUFLLGFBQUNILFlBQUQsRUFBa0I7QUFBQSxPQUVkSSxhQUZjLEdBRWtFSixZQUZsRSxDQUVkSSxhQUZjO0FBQUEsT0FFQ0MsY0FGRCxHQUVrRUwsWUFGbEUsQ0FFQ0ssY0FGRDtBQUFBLE9BRWlCQyxjQUZqQixHQUVrRU4sWUFGbEUsQ0FFaUJNLGNBRmpCO0FBQUEsT0FFaUNDLFlBRmpDLEdBRWtFUCxZQUZsRSxDQUVpQ08sWUFGakM7QUFBQSxPQUUrQ0MsY0FGL0MsR0FFa0VSLFlBRmxFLENBRStDUSxjQUYvQzs7O0FBSXRCVixzQkFBbUIsRUFBRUcsYUFBYUcsYUFBZixFQUFuQjs7QUFFQSxVQUFPLHFCQUFNSSxrQkFBa0IsRUFBeEIsRUFDTEMsSUFESyxDQUNBLFVBQUNDLEdBQUQsRUFBUzs7QUFFZFosdUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYUksY0FBcEIsRUFBbkI7O0FBRUFQLHVCQUFtQixFQUFFWSxRQUFGLEVBQU9ULGFBQWFNLFlBQXBCLEVBQW5COztBQUVBLFdBQU9HLEdBQVA7QUFFQSxJQVRLLEVBVUxDLEtBVkssQ0FVQyxVQUFDQyxLQUFELEVBQVc7O0FBRWpCZCx1QkFBbUIsRUFBRWMsWUFBRixFQUFTWCxhQUFhSyxjQUF0QixFQUFuQjs7QUFFQVIsdUJBQW1CLEVBQUVjLFlBQUYsRUFBU1gsYUFBYU0sWUFBdEIsRUFBbkI7QUFFQSxJQWhCSyxDQUFQO0FBaUJBLEdBakNLOztBQW1DTk0sYUFBVyxtQkFBQ2IsWUFBRCxFQUFrQjtBQUM1QjtBQUQ0QixPQUVwQkksYUFGb0IsR0FFNERKLFlBRjVELENBRXBCSSxhQUZvQjtBQUFBLE9BRUxDLGNBRkssR0FFNERMLFlBRjVELENBRUxLLGNBRks7QUFBQSxPQUVXQyxjQUZYLEdBRTRETixZQUY1RCxDQUVXTSxjQUZYO0FBQUEsT0FFMkJDLFlBRjNCLEdBRTREUCxZQUY1RCxDQUUyQk8sWUFGM0I7QUFBQSxPQUV5Q0MsY0FGekMsR0FFNERSLFlBRjVELENBRXlDUSxjQUZ6Qzs7O0FBSTVCVixzQkFBbUIsRUFBRUcsYUFBYUcsYUFBZixFQUFuQjs7QUFFQTtBQUNBLE9BQU1VLEtBQUssSUFBSUMsU0FBSixDQUFjUCxlQUFlUSxHQUE3QixDQUFYOztBQUVBLE9BQU1DLGFBQTZCQyxPQUFPQyxJQUFQLENBQVluQixZQUFaLEVBQTBCb0IsTUFBMUIsQ0FBaUMsVUFBQ0MsSUFBRCxFQUFrQjtBQUNyRixXQUFPQSxRQUFRLGdCQUFSLElBQTRCQSxRQUFRLE9BQTNDO0FBQ0EsSUFGa0MsQ0FBbkM7O0FBSUE7OztBQUdBOztBQWhCNEIsOEJBaUJuQkMsQ0FqQm1CO0FBa0IzQixRQUFNQyxZQUFZTixXQUFXSyxDQUFYLENBQWxCO0FBQ0EsUUFBTXJCLGNBQWNELGFBQWF1QixTQUFiLENBQXBCOztBQUVBVCxPQUFHVSxnQkFBSCxDQUFvQkQsU0FBcEIsRUFBK0IsVUFBQ2IsR0FBRCxFQUFTOztBQUV2Q1osd0JBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYUEsV0FBcEIsRUFBbkI7O0FBRUE7QUFFQSxLQU5EO0FBckIyQjs7QUFpQjVCLFFBQUssSUFBSXFCLElBQUlMLFdBQVdRLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NILEtBQUssQ0FBekMsRUFBNENBLEdBQTVDLEVBQWlEO0FBQUEsVUFBeENBLENBQXdDO0FBV2hEOztBQUVEO0FBQ0FSLE1BQUdVLGdCQUFILENBQW9CLE9BQXBCLEVBQTZCLFVBQUNaLEtBQUQsRUFBVzs7QUFFdkNkLHVCQUFtQixFQUFFYyxZQUFGLEVBQVNYLGFBQWFLLGNBQXRCLEVBQW5CO0FBRUEsSUFKRDtBQU1BLEdBeEVLOztBQTJFTjtBQUNBb0IsYUFBVyxDQUFDN0IsUUFBRCxHQUFZOEIsU0FBWixHQUF3QixVQUFDM0IsWUFBRCxFQUFrQjtBQUFBLE9BRTVDSSxhQUY0QyxHQUVvQ0osWUFGcEMsQ0FFNUNJLGFBRjRDO0FBQUEsT0FFN0JDLGNBRjZCLEdBRW9DTCxZQUZwQyxDQUU3QkssY0FGNkI7QUFBQSxPQUViQyxjQUZhLEdBRW9DTixZQUZwQyxDQUViTSxjQUZhO0FBQUEsT0FFR0MsWUFGSCxHQUVvQ1AsWUFGcEMsQ0FFR08sWUFGSDtBQUFBLE9BRWlCQyxjQUZqQixHQUVvQ1IsWUFGcEMsQ0FFaUJRLGNBRmpCOzs7QUFJcERWLHNCQUFtQixFQUFFRyxhQUFhRyxhQUFmLEVBQW5COztBQUpvRCxPQU01Q3dCLE9BTjRDLEdBTUxwQixjQU5LLENBTTVDb0IsT0FONEM7QUFBQSxPQU1uQ0MsUUFObUMsR0FNTHJCLGNBTkssQ0FNbkNxQixRQU5tQztBQUFBLE9BTXpCQyxTQU55QixHQU1MdEIsY0FOSyxDQU16QnNCLFNBTnlCO0FBQUEsT0FNZEMsSUFOYyxHQU1MdkIsY0FOSyxDQU1kdUIsSUFOYzs7QUFRcEQ7QUFDQTs7QUFDQSxVQUFPQSxPQUNKbEMsU0FBUzZCLFNBQVQsQ0FBbUJFLE9BQW5CLEVBQTRCQyxTQUFTRyxJQUFULENBQWMsR0FBZCxDQUE1QixFQUFnREYsU0FBaEQsRUFBMkRDLElBQTNELEVBQ0F0QixJQURBLENBQ0ssVUFBQ0MsR0FBRCxFQUFTOztBQUVkWix1QkFBbUIsRUFBRVksUUFBRixFQUFPVCxhQUFhSSxjQUFwQixFQUFuQjs7QUFFQVAsdUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYU0sWUFBcEIsRUFBbkI7O0FBRUEsV0FBT0csR0FBUDtBQUNBLElBUkEsRUFTQUMsS0FUQSxDQVNNLFVBQUNDLEtBQUQsRUFBVzs7QUFFakJkLHVCQUFtQixFQUFFYyxZQUFGLEVBQVNYLGFBQWFLLGNBQXRCLEVBQW5COztBQUVBUix1QkFBbUIsRUFBRWMsWUFBRixFQUFTWCxhQUFhTSxZQUF0QixFQUFuQjtBQUdBLElBaEJBLENBREksR0FrQkhWLFNBQVM2QixTQUFULENBQW1CRSxPQUFuQixFQUE0QkMsU0FBU0csSUFBVCxDQUFjLEdBQWQsQ0FBNUIsRUFBZ0RGLFNBQWhELElBQ0RyQixJQURDLENBQ0ksVUFBQ0MsR0FBRCxFQUFTOztBQUVkWix1QkFBbUIsRUFBRVksUUFBRixFQUFPVCxhQUFhSSxjQUFwQixFQUFuQjs7QUFFQVAsdUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYU0sWUFBcEIsRUFBbkI7O0FBRUEsV0FBT0csR0FBUDtBQUNBLElBUkMsRUFTREMsS0FUQyxDQVNLLFVBQUNDLEtBQUQsRUFBVzs7QUFFakJkLHVCQUFtQixFQUFFYyxZQUFGLEVBQVNYLGFBQWFLLGNBQXRCLEVBQW5COztBQUVBUix1QkFBbUIsRUFBRWMsWUFBRixFQUFTWCxhQUFhTSxZQUF0QixFQUFuQjtBQUVBLElBZkMsQ0FsQko7QUFrQ0EsR0F4SEs7O0FBMEhOO0FBQ0EwQixnQkFBYyxDQUFDcEMsUUFBRCxHQUFZOEIsU0FBWixHQUF3QixVQUFDM0IsWUFBRCxFQUFrQjtBQUFBLE9BRS9DSSxhQUYrQyxHQUVpQ0osWUFGakMsQ0FFL0NJLGFBRitDO0FBQUEsT0FFaENDLGNBRmdDLEdBRWlDTCxZQUZqQyxDQUVoQ0ssY0FGZ0M7QUFBQSxPQUVoQkMsY0FGZ0IsR0FFaUNOLFlBRmpDLENBRWhCTSxjQUZnQjtBQUFBLE9BRUFDLFlBRkEsR0FFaUNQLFlBRmpDLENBRUFPLFlBRkE7QUFBQSxPQUVjQyxjQUZkLEdBRWlDUixZQUZqQyxDQUVjUSxjQUZkOzs7QUFJdkRWLHNCQUFtQixFQUFFRyxhQUFhRyxhQUFmLEVBQW5COztBQUp1RCxPQU0vQzhCLFVBTitDLEdBTUUxQixjQU5GLENBTS9DMEIsVUFOK0M7QUFBQSxPQU1uQ0MsS0FObUMsR0FNRTNCLGNBTkYsQ0FNbkMyQixLQU5tQztBQUFBLE9BTTVCQyxRQU40QixHQU1FNUIsY0FORixDQU01QjRCLFFBTjRCO0FBQUEsT0FNbEJDLGVBTmtCLEdBTUU3QixjQU5GLENBTWxCNkIsZUFOa0I7OztBQVF2RCxXQUFRSCxVQUFSOztBQUVDLFNBQUssNEJBQUw7QUFDQyxZQUFPckMsU0FBU3lDLElBQVQsQ0FBY0MsY0FBZCxDQUE4QkYsbUJBQW1CLE1BQWpELEVBQ0w1QixJQURLLENBQ0EsWUFBTTtBQUNYLGFBQVFaLFNBQVN5QyxJQUFULENBQWNFLDBCQUFkLENBQXlDTCxLQUF6QyxFQUFnREMsUUFBaEQsRUFDTjNCLElBRE0sQ0FDRCxVQUFDQyxHQUFELEVBQVM7O0FBRWRaLDBCQUFtQixFQUFFWSxRQUFGLEVBQU9ULGFBQWFJLGNBQXBCLEVBQW5COztBQUVBUCwwQkFBbUIsRUFBRVksUUFBRixFQUFPVCxhQUFhTSxZQUFwQixFQUFuQjs7QUFFQSxjQUFPRyxHQUFQO0FBRUEsT0FUTSxDQUFSO0FBVUEsTUFaSyxFQWFMQyxLQWJLLENBYUMsVUFBQ0MsS0FBRCxFQUFXOztBQUVqQmQseUJBQW1CLEVBQUVjLFlBQUYsRUFBU1gsYUFBYUssY0FBdEIsRUFBbkI7O0FBRUFSLHlCQUFtQixFQUFFYyxZQUFGLEVBQVNYLGFBQWFNLFlBQXRCLEVBQW5CO0FBRUEsTUFuQkssQ0FBUDs7QUFxQkQsU0FBSyxTQUFMO0FBQ0MsWUFBT1YsU0FBU3lDLElBQVQsQ0FBY0csT0FBZCxHQUNMaEMsSUFESyxDQUNBLFVBQUNDLEdBQUQsRUFBUzs7QUFFZFoseUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYUksY0FBcEIsRUFBbkI7O0FBRUFQLHlCQUFtQixFQUFFWSxRQUFGLEVBQU9ULGFBQWFNLFlBQXBCLEVBQW5CO0FBRUEsTUFQSyxFQVFMSSxLQVJLLENBUUMsVUFBQ0MsS0FBRCxFQUFXOztBQUVqQmQseUJBQW1CLEVBQUVjLFlBQUYsRUFBU1gsYUFBYUssY0FBdEIsRUFBbkI7O0FBRUFSLHlCQUFtQixFQUFFYyxZQUFGLEVBQVNYLGFBQWFNLFlBQXRCLEVBQW5CO0FBRUEsTUFkSyxDQUFQOztBQWdCRCxTQUFLLGdDQUFMO0FBQ0MsWUFBT1YsU0FBU3lDLElBQVQsQ0FBY0ksOEJBQWQsQ0FBNkNQLEtBQTdDLEVBQW9EQyxRQUFwRCxFQUNMM0IsSUFESyxDQUNBLFVBQUNDLEdBQUQsRUFBUzs7QUFFZFoseUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYUksY0FBcEIsRUFBbkI7O0FBRUFQLHlCQUFtQixFQUFFWSxRQUFGLEVBQU9ULGFBQWFNLFlBQXBCLEVBQW5COztBQUVBLGFBQU9HLEdBQVA7QUFFQSxNQVRLLEVBVUxDLEtBVkssQ0FVQyxVQUFDQyxLQUFELEVBQVc7O0FBRWpCZCx5QkFBbUIsRUFBRWMsWUFBRixFQUFTWCxhQUFhSyxjQUF0QixFQUFuQjs7QUFFQVIseUJBQW1CLEVBQUVjLFlBQUYsRUFBU1gsYUFBYU0sWUFBdEIsRUFBbkI7QUFFQSxNQWhCSyxDQUFQOztBQWtCRDtBQUNBLFNBQUssb0JBQUw7QUFDQyxZQUFPVixTQUFTeUMsSUFBVCxDQUFjSyxrQkFBZCxDQUFpQyxVQUFDakMsR0FBRCxFQUFTO0FBQUU7O0FBRWxEWix5QkFBbUIsRUFBRVksUUFBRixFQUFPVCxhQUFhQyxXQUFXRyxjQUEvQixFQUFuQjs7QUFFQVAseUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYU0sWUFBcEIsRUFBbkI7QUFFQSxNQU5NLENBQVA7O0FBUUQ7O0FBRUE7QUFDRTtBQXpFSDtBQTJFQSxHQTlNSzs7QUFnTk47QUFDQVYsWUFBVSxDQUFDQSxRQUFELEdBQVk4QixTQUFaLEdBQXdCLFVBQUUzQixZQUFGLEVBQW9CO0FBQUEsT0FFN0NJLGFBRjZDLEdBRW1DSixZQUZuQyxDQUU3Q0ksYUFGNkM7QUFBQSxPQUU5QkMsY0FGOEIsR0FFbUNMLFlBRm5DLENBRTlCSyxjQUY4QjtBQUFBLE9BRWRDLGNBRmMsR0FFbUNOLFlBRm5DLENBRWRNLGNBRmM7QUFBQSxPQUVFQyxZQUZGLEdBRW1DUCxZQUZuQyxDQUVFTyxZQUZGO0FBQUEsT0FFZ0JDLGNBRmhCLEdBRW1DUixZQUZuQyxDQUVnQlEsY0FGaEI7O0FBSXJEOztBQUNBVixzQkFBbUIsRUFBRUcsYUFBYUcsYUFBZixFQUFuQjs7QUFMcUQsT0FPN0N3QyxHQVA2QyxHQU9uQnBDLGNBUG1CLENBTzdDb0MsR0FQNkM7QUFBQSxPQU94Q0MsVUFQd0MsR0FPbkJyQyxjQVBtQixDQU94Q3FDLFVBUHdDO0FBQUEsT0FPNUJkLElBUDRCLEdBT25CdkIsY0FQbUIsQ0FPNUJ1QixJQVA0Qjs7O0FBU3JELFVBQU9BLE9BQ0xsQyxTQUFTQSxRQUFULENBQWtCK0MsR0FBbEIsQ0FBc0JBLEdBQXRCLEVBQTJCQyxVQUEzQixFQUF1Q2QsSUFBdkMsRUFDQ3RCLElBREQsQ0FDTSxVQUFDQyxHQUFELEVBQVM7O0FBRWRaLHVCQUFtQixFQUFFWSxRQUFGLEVBQU9ULGFBQWFJLGNBQXBCLEVBQW5COztBQUVBUCx1QkFBbUIsRUFBRVksUUFBRixFQUFPVCxhQUFhTSxZQUFwQixFQUFuQjs7QUFFQSxXQUFPRyxHQUFQO0FBQ0EsSUFSRCxFQVNDQyxLQVRELENBU08sVUFBQ0MsS0FBRCxFQUFXOztBQUVqQmQsdUJBQW1CLEVBQUVjLFlBQUYsRUFBU1gsYUFBYUssY0FBdEIsRUFBbkI7O0FBRUFSLHVCQUFtQixFQUFFYyxZQUFGLEVBQVNYLGFBQWFNLFlBQXRCLEVBQW5CO0FBRUEsSUFmRCxDQURLLEdBaUJMVixTQUFTQSxRQUFULENBQWtCK0MsR0FBbEIsQ0FBc0JBLEdBQXRCLEVBQTJCQyxVQUEzQixJQUNDcEMsSUFERCxDQUNNLFVBQUNDLEdBQUQsRUFBUzs7QUFFZFosdUJBQW1CLEVBQUVZLFFBQUYsRUFBT1QsYUFBYUksY0FBcEIsRUFBbkI7O0FBRUFQLHVCQUFtQixFQUFFWSxRQUFGLEVBQU9ULGFBQWFNLFlBQXBCLEVBQW5COztBQUVBLFdBQU9HLEdBQVA7QUFDQSxJQVJELEVBU0NDLEtBVEQsQ0FTTyxVQUFDQyxLQUFELEVBQVc7O0FBRWpCZCx1QkFBbUIsRUFBRWMsWUFBRixFQUFTWCxhQUFhSyxjQUF0QixFQUFuQjs7QUFFQVIsdUJBQW1CLEVBQUVjLFlBQUYsRUFBU1gsYUFBYU0sWUFBdEIsRUFBbkI7QUFFQSxJQWZELENBakJGO0FBaUNBLEdBM1BLOztBQTZQTnVDLDBCQUF3QixDQUFDakQsUUFBRCxHQUFZOEIsU0FBWixHQUF3QixVQUFFM0IsWUFBRixFQUFvQjtBQUFBLE9BRTNEK0MsZUFGMkQsR0FFdkIvQyxZQUZ1QixDQUUzRCtDLGVBRjJEO0FBQUEsT0FFMUN2QyxjQUYwQyxHQUV2QlIsWUFGdUIsQ0FFMUNRLGNBRjBDO0FBQUEsT0FJM0RvQyxHQUoyRCxHQUl0Q3BDLGNBSnNDLENBSTNEb0MsR0FKMkQ7QUFBQSxPQUl0REksV0FKc0QsR0FJdEN4QyxjQUpzQyxDQUl0RHdDLFdBSnNEOzs7QUFNbkVuRCxZQUFTQSxRQUFULENBQWtCK0MsR0FBbEIsQ0FBc0JBLEdBQXRCLEVBQTJCSyxFQUEzQixDQUE4QkQsV0FBOUIsRUFBMkMsVUFBQ3RDLEdBQUQsRUFBUzs7QUFFbkR3QyxZQUFRQyxHQUFSLENBQVkseUNBQVosRUFBdUR6QyxHQUF2RCxFQUE0REEsSUFBSTBDLEdBQUosRUFBNUQ7O0FBRUF0RCx1QkFBbUIsRUFBRVksUUFBRixFQUFPVCxhQUFhOEMsZUFBcEIsRUFBbkI7QUFFQSxJQU5EO0FBT0E7O0FBRUQ7QUFDRTtBQUNGO0FBQ0U7QUFDRjtBQUNFO0FBQ0Y7QUFDRTtBQUNBO0FBQ0E7QUFDRjtBQUNBO0FBQ0U7QUFDRjtBQUNFO0FBQ0Y7QUFDRTtBQUNGO0FBQ0E7QUFDRTtBQUNGO0FBQ0U7QUFDRjtBQUNFO0FBQ0Y7QUFDQTtBQXJTTSxFQUFQO0FBdVNBLEMiLCJmaWxlIjoiY3JlYXRlVXBkYXRlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnXG5cbmV4cG9ydCBkZWZhdWx0ICh7IHVwZGF0ZXJQYXJ0cywgZmlyZWJhc2UgfSkgPT4ge1xuXG5cdGNvbnN0IHsgcHJvY2Vzc0FjdGlvbkdyb3VwIH0gPSB1cGRhdGVyUGFydHNcblxuXHRyZXR1cm4ge1xuXG5cdFx0c3RvcmU6IChpbnN0cnVjdGlvbnMpID0+IHtcblxuXHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgYWN0aW9uR3JvdXA6IGluc3RydWN0aW9ucy5hY3Rpb25zIH0pXG5cblx0XHRcdHJldHVybiB0cnVlXG5cblx0XHR9LFxuXG5cdFx0YXBpOiAoaW5zdHJ1Y3Rpb25zKSA9PiB7XG5cblx0XHRcdGNvbnN0IHsgYmVmb3JlQWN0aW9ucywgc3VjY2Vzc0FjdGlvbnMsIGZhaWx1cmVBY3Rpb25zLCBhZnRlckFjdGlvbnMsIHNlcnZpY2VPcHRpb25zIH0gPSBpbnN0cnVjdGlvbnNcblxuXHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgYWN0aW9uR3JvdXA6IGJlZm9yZUFjdGlvbnMgfSlcblxuXHRcdFx0cmV0dXJuIGF4aW9zKHNlcnZpY2VPcHRpb25zIHx8IHt9KVxuXHRcdFx0XHQudGhlbigocmVzKSA9PiB7XG5cblx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBzdWNjZXNzQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRyZXR1cm4gcmVzXG5cblx0XHRcdFx0fSlcblx0XHRcdFx0LmNhdGNoKChlcnJvcikgPT4ge1xuXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHR9KVxuXHRcdH0sXG5cblx0XHR3ZWJzb2NrZXQ6IChpbnN0cnVjdGlvbnMpID0+IHtcblx0XHRcdC8vIEBUT0RPXG5cdFx0XHRjb25zdCB7IGJlZm9yZUFjdGlvbnMsIHN1Y2Nlc3NBY3Rpb25zLCBmYWlsdXJlQWN0aW9ucywgYWZ0ZXJBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGFjdGlvbkdyb3VwOiBiZWZvcmVBY3Rpb25zIH0pXG5cblx0XHRcdC8vIHNvY2tldCBjb25uZWN0aW9uXG5cdFx0XHRjb25zdCB3cyA9IG5ldyBXZWJTb2NrZXQoc2VydmljZU9wdGlvbnMudXJsKVxuXG5cdFx0XHRjb25zdCBldmVudE5hbWVzOiBBcnJheTxzdHJpbmc+ICA9IE9iamVjdC5rZXlzKGluc3RydWN0aW9ucykuZmlsdGVyKChuYW1lOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0cmV0dXJuIG5hbWUgIT0gJ3NlcnZpY2VPcHRpb25zJyAmJiBuYW1lICE9ICdlcnJvcidcblx0XHRcdH0pXG5cblx0XHRcdC8vIFRPRE8gYWRkIGFsbCBwb3NzaWJsZSBldmVudCBuYW1lc1xuXG5cblx0XHRcdC8vIGhhbmRsZSBub24tZXJyb3IgZXZlbnRzXG5cdFx0XHRmb3IgKGxldCBpID0gZXZlbnROYW1lcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuXHRcdFx0XHRjb25zdCBldmVudE5hbWUgPSBldmVudE5hbWVzW2ldXG5cdFx0XHRcdGNvbnN0IGFjdGlvbkdyb3VwID0gaW5zdHJ1Y3Rpb25zW2V2ZW50TmFtZV1cblxuXHRcdFx0XHR3cy5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogYWN0aW9uR3JvdXAgfSlcblxuXHRcdFx0XHRcdC8vIFRPRE8gaGFuZGxlIHNlbmRpbmcgbWVzc2FnZXNcblxuXHRcdFx0XHR9KVxuXHRcdFx0fVxuXG5cdFx0XHQvLyBoYW5kbGUgZXJyb3Jcblx0XHRcdHdzLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgKGVycm9yKSA9PiB7XG5cblx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHR9KVxuXG5cdFx0fSxcblxuXG5cdFx0Ly8gQ1JVRCBmb3IgZmlyZXN0b3JlIGNvbGxlY3Rpb25zIGFuZCBkb2NzXG5cdFx0ZmlyZXN0b3JlOiAhZmlyZWJhc2UgPyB1bmRlZmluZWQgOiAoaW5zdHJ1Y3Rpb25zKSA9PiB7XG5cblx0XHRcdGNvbnN0IHsgYmVmb3JlQWN0aW9ucywgc3VjY2Vzc0FjdGlvbnMsIGZhaWx1cmVBY3Rpb25zLCBhZnRlckFjdGlvbnMsIHNlcnZpY2VPcHRpb25zIH0gPSBpbnN0cnVjdGlvbnNcblxuXHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgYWN0aW9uR3JvdXA6IGJlZm9yZUFjdGlvbnMgfSlcblxuXHRcdFx0Y29uc3QgeyByZWZUeXBlLCByZWZBcnJheSwgb3BlcmF0aW9uLCBhcmdzIH0gPSBzZXJ2aWNlT3B0aW9uc1xuXG5cdFx0XHQvLyBJZiBhIGRvY0lkIGlzIHN1cHBsaWVkLCB0aGVuIGEgZG9jIGlzIHJlZmVyZW5jZWQsIG90aGVyd2lzZSBhIGNvbGxlY3Rpb24gaXMgcmVmZXJlbmNlZFxuXHRcdFx0Ly8gVE9ETyBtYXkgbmVlZCB0byBoYW5kbGUgbW9yZSBjb21wbGljYXRlZCByZWZlcmVuY2VzXG5cdFx0XHRyZXR1cm4gYXJnc1xuXHRcdFx0XHQ/IGZpcmViYXNlLmZpcmVzdG9yZVtyZWZUeXBlXShyZWZBcnJheS5qb2luKCcvJykpW29wZXJhdGlvbl0oYXJncylcblx0XHRcdFx0XHQudGhlbigocmVzKSA9PiB7XG5cblx0XHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IHJlcywgYWN0aW9uR3JvdXA6IHN1Y2Nlc3NBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IHJlcywgYWN0aW9uR3JvdXA6IGFmdGVyQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQuY2F0Y2goKGVycm9yKSA9PiB7XG5cblx0XHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogZmFpbHVyZUFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0OiAgZmlyZWJhc2UuZmlyZXN0b3JlW3JlZlR5cGVdKHJlZkFycmF5LmpvaW4oJy8nKSlbb3BlcmF0aW9uXSgpXG5cdFx0XHRcdFx0LnRoZW4oKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBzdWNjZXNzQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LmNhdGNoKChlcnJvcikgPT4ge1xuXG5cdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGZhaWx1cmVBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHR9KVxuXHRcdH0sXG5cblx0XHQvLyB1c2VkIHRvIHNpZ251cCwgc2lnbmluZywgYW5kIHNpZ25vdXQgb2YgRmlyZWJhc2UgQXV0aFxuXHRcdGZpcmViYXNlQXV0aDogIWZpcmViYXNlID8gdW5kZWZpbmVkIDogKGluc3RydWN0aW9ucykgPT4ge1xuXG5cdFx0XHRjb25zdCB7IGJlZm9yZUFjdGlvbnMsIHN1Y2Nlc3NBY3Rpb25zLCBmYWlsdXJlQWN0aW9ucywgYWZ0ZXJBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGFjdGlvbkdyb3VwOiBiZWZvcmVBY3Rpb25zIH0pXG5cblx0XHRcdGNvbnN0IHsgYXV0aE1ldGhvZCwgZW1haWwsIHBhc3N3b3JkLCBwZXJzaXN0ZW5jZVR5cGUgfSA9IHNlcnZpY2VPcHRpb25zXG5cblx0XHRcdHN3aXRjaCAoYXV0aE1ldGhvZCkge1xuXG5cdFx0XHRcdGNhc2UgJ3NpZ25JbldpdGhFbWFpbEFuZFBhc3N3b3JkJzpcblx0XHRcdFx0XHRyZXR1cm4gZmlyZWJhc2UuYXV0aC5zZXRQZXJzaXN0ZW5jZSggcGVyc2lzdGVuY2VUeXBlIHx8ICdub25lJyApXG5cdFx0XHRcdFx0XHQudGhlbigoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdHJldHVybiAgZmlyZWJhc2UuYXV0aC5zaWduSW5XaXRoRW1haWxBbmRQYXNzd29yZChlbWFpbCwgcGFzc3dvcmQpXG5cdFx0XHRcdFx0XHRcdFx0LnRoZW4oKHJlcykgPT4ge1xuXG5cdFx0XHRcdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBzdWNjZXNzQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuIHJlc1xuXG5cdFx0XHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHQuY2F0Y2goKGVycm9yKSA9PiB7XG5cblx0XHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdH0pXG5cblx0XHRcdFx0Y2FzZSAnc2lnbk91dCc6XG5cdFx0XHRcdFx0cmV0dXJuIGZpcmViYXNlLmF1dGguc2lnbk91dCgpXG5cdFx0XHRcdFx0XHQudGhlbigocmVzKSA9PiB7XG5cblx0XHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdC5jYXRjaCgoZXJyb3IpID0+IHtcblxuXHRcdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGZhaWx1cmVBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0fSlcblxuXHRcdFx0XHRjYXNlICdjcmVhdGVVc2VyV2l0aEVtYWlsQW5kUGFzc3dvcmQnOlxuXHRcdFx0XHRcdHJldHVybiBmaXJlYmFzZS5hdXRoLmNyZWF0ZVVzZXJXaXRoRW1haWxBbmRQYXNzd29yZChlbWFpbCwgcGFzc3dvcmQpXG5cdFx0XHRcdFx0XHQudGhlbigocmVzKSA9PiB7XG5cblx0XHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gcmVzXG5cblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHQuY2F0Y2goKGVycm9yKSA9PiB7XG5cblx0XHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdH0pXG5cblx0XHRcdFx0Ly8gdXNlIHRoaXMgdG8gbG9nIHVzZXIgaW50byByZWR1eCB3aXRoIHBlcnNpc3RlbnQgZmlyZWJhc2UgYXV0aFxuXHRcdFx0XHRjYXNlICdvbkF1dGhTdGF0ZUNoYW5nZWQnOlxuXHRcdFx0XHRcdHJldHVybiBmaXJlYmFzZS5hdXRoLm9uQXV0aFN0YXRlQ2hhbmdlZCgocmVzKSA9PiB7IC8vIHRoaXMgd2lsbCBiZSB0aGUgdXNlciBvYmplY3RcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogYWN0aW9ucyB8fCBzdWNjZXNzQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyByZXMsIGFjdGlvbkdyb3VwOiBhZnRlckFjdGlvbnMgfSlcblxuXHRcdFx0XHRcdH0pXG5cblx0XHRcdFx0Ly8gVE9ETzogc29jaWFsIGF1dGhcblxuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHQgXHRyZXR1cm5cblx0XHRcdH1cblx0XHR9LFxuXG5cdFx0Ly8gdXNlIGZvciByZWFsdGltZSBmaXJlYmFzZSBDUlVEXG5cdFx0ZmlyZWJhc2U6ICFmaXJlYmFzZSA/IHVuZGVmaW5lZCA6ICggaW5zdHJ1Y3Rpb25zICkgPT4ge1xuXG5cdFx0XHRjb25zdCB7IGJlZm9yZUFjdGlvbnMsIHN1Y2Nlc3NBY3Rpb25zLCBmYWlsdXJlQWN0aW9ucywgYWZ0ZXJBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdC8vIHByb2Nlc3MgYmVmb3JlIGFjdGlvbnNcblx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGFjdGlvbkdyb3VwOiBiZWZvcmVBY3Rpb25zIH0pXG5cblx0XHRcdGNvbnN0IHsgcmVmLCBtZXRob2ROYW1lLCBhcmdzIH0gPSBzZXJ2aWNlT3B0aW9uc1xuXG5cdFx0XHRyZXR1cm4gYXJnc1xuXHRcdFx0PyBmaXJlYmFzZS5maXJlYmFzZS5yZWYocmVmKVttZXRob2ROYW1lXShhcmdzKVxuXHRcdFx0XHRcdC50aGVuKChyZXMpID0+IHtcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdC5jYXRjaCgoZXJyb3IpID0+IHtcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGFmdGVyQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0fSlcblx0XHRcdDogZmlyZWJhc2UuZmlyZWJhc2UucmVmKHJlZilbbWV0aG9kTmFtZV0oKVxuXHRcdFx0XHRcdC50aGVuKChyZXMpID0+IHtcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG5cblx0XHRcdFx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdC5jYXRjaCgoZXJyb3IpID0+IHtcblxuXHRcdFx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgZXJyb3IsIGFjdGlvbkdyb3VwOiBmYWlsdXJlQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0XHRwcm9jZXNzQWN0aW9uR3JvdXAoeyBlcnJvciwgYWN0aW9uR3JvdXA6IGFmdGVyQWN0aW9ucyB9KVxuXG5cdFx0XHRcdFx0fSlcblx0XHR9LFxuXG5cdFx0YXR0YWNoRmlyZWJhc2VMaXN0ZW5lcjogIWZpcmViYXNlID8gdW5kZWZpbmVkIDogKCBpbnN0cnVjdGlvbnMgKSA9PiB7XG5cblx0XHRcdGNvbnN0IHsgb25DaGFuZ2VBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucyB9ID0gaW5zdHJ1Y3Rpb25zXG5cblx0XHRcdGNvbnN0IHsgcmVmLCBldmVudE1ldGhvZCB9ID0gc2VydmljZU9wdGlvbnNcblxuXHRcdFx0ZmlyZWJhc2UuZmlyZWJhc2UucmVmKHJlZikub24oZXZlbnRNZXRob2QsIChyZXMpID0+IHtcblxuXHRcdFx0XHRjb25zb2xlLmxvZygnY2hhbmdlIGRldGVjdGVkIGluIHJlYWx0aW1lIGRiIGF0IHJlZjogJywgcmVzLCByZXMudmFsKCkpXG5cblx0XHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogb25DaGFuZ2VBY3Rpb25zIH0pXG5cblx0XHRcdH0pXG5cdFx0fSxcblxuXHRcdC8vIGZpcmViYXNlU3RvcmFnZTogIWZpcmViYXNlID8gdW5kZWZpbmVkIDogKCBpbnN0cnVjdGlvbnMgKSA9PiB7XG4gICAgLy9cblx0XHQvLyBcdGNvbnN0IHsgc3VjY2Vzc0FjdGlvbnMsIGZhaWx1cmVBY3Rpb25zLCBzZXJ2aWNlT3B0aW9ucywgYWZ0ZXJBY3Rpb25zIH0gPSBpbnN0cnVjdGlvbnNcbiAgICAvL1xuXHRcdC8vIFx0Y29uc3QgeyByZWYsIG1ldGhvZE5hbWUsIGZpbGUsIG1ldGFkYXRhIH0gPSBzZXJ2aWNlT3B0aW9uc1xuICAgIC8vXG5cdFx0Ly8gXHRjb25zdCB1cGxvYWRUYXNrID0gZmlyZWJhc2Uuc3RvcmFnZS5yZWYocmVmKVttZXRob2ROYW1lXShmaWxlKVxuICAgIC8vXG4gICAgLy9cbiAgICAvL1xuXHRcdC8vIFx0cmV0dXJuIHVwbG9hZFRhc2tcblx0XHQvLyBcdFx0LnRoZW4oKHJlcykgPT4ge1xuICAgIC8vXG5cdFx0Ly8gXHRcdFx0cHJvY2Vzc0FjdGlvbkdyb3VwKHsgcmVzLCBhY3Rpb25Hcm91cDogc3VjY2Vzc0FjdGlvbnMgfSlcbiAgICAvL1xuXHRcdC8vIFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IHJlcywgYWN0aW9uR3JvdXA6IGFmdGVyQWN0aW9ucyB9KVxuICAgIC8vXG5cdFx0Ly8gXHRcdH0pXG5cdFx0Ly8gXHRcdC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAvL1xuXHRcdC8vIFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogZmFpbHVyZUFjdGlvbnMgfSlcbiAgICAvL1xuXHRcdC8vIFx0XHRcdHByb2Nlc3NBY3Rpb25Hcm91cCh7IGVycm9yLCBhY3Rpb25Hcm91cDogYWZ0ZXJBY3Rpb25zIH0pXG4gICAgLy9cblx0XHQvLyBcdFx0fSlcblx0XHQvLyB9XG5cdH1cbn1cbiJdfQ==
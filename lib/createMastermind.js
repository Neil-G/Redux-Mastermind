'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _createUpdaterParts = require('./createUpdaterParts');

var _createUpdaterParts2 = _interopRequireDefault(_createUpdaterParts);

var _createUpdaters = require('./createUpdaters');

var _createUpdaters2 = _interopRequireDefault(_createUpdaters);

var _configureFirebase = require('./configureFirebase');

var _configureFirebase2 = _interopRequireDefault(_configureFirebase);

var _configureReducers = require('./configureReducers');

var _configureReducers2 = _interopRequireDefault(_configureReducers);

var _Docs = require('./Docs');

var _Docs2 = _interopRequireDefault(_Docs);

var _redux = require('redux');

var _reduxLogger = require('redux-logger');

var _reduxLogger2 = _interopRequireDefault(_reduxLogger);

var _defaultUpdateSchemaCreators = require('./defaultUpdateSchemaCreators');

var _defaultUpdateSchemaCreators2 = _interopRequireDefault(_defaultUpdateSchemaCreators);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var uuidv1 = require('uuid/v1');

var genericStoreUpdate = _defaultUpdateSchemaCreators2.default.genericStoreUpdate,
    genericApiUpdate = _defaultUpdateSchemaCreators2.default.genericApiUpdate,
    firebaseSignInWithEmail = _defaultUpdateSchemaCreators2.default.firebaseSignInWithEmail,
    firebaseSignOut = _defaultUpdateSchemaCreators2.default.firebaseSignOut,
    genericFirestoreUpdate = _defaultUpdateSchemaCreators2.default.genericFirestoreUpdate;


var actionGroupKeys = ['actions', 'beforeActions', 'successActions', 'failureActions', 'afterActions'];

// TODO, add reduxConfig as an option to validate branches
// TODO validate operations against locations

exports.default = function (_ref) {
	var _ref$options = _ref.options,
	    options = _ref$options === undefined ? {} : _ref$options,
	    _ref$initialStoreStat = _ref.initialStoreState,
	    initialStoreState = _ref$initialStoreStat === undefined ? {} : _ref$initialStoreStat,
	    _ref$updateSchemaCrea = _ref.updateSchemaCreators,
	    updateSchemaCreators = _ref$updateSchemaCrea === undefined ? {} : _ref$updateSchemaCrea,
	    firebaseConfig = _ref.firebaseConfig;


	/*** INITIALIZE AND CHECK ARGUMENTS ***/

	// initialize options
	options = options || {};

	// initialize initialStoreState
	initialStoreState.appState = Object.assign({}, { isFetching: {}, errors: {}, modals: {} }, initialStoreState.appState || {});
	initialStoreState.auth = Object.assign({}, { user: {} }, initialStoreState.auth || {});
	initialStoreState.data = initialStoreState.data || {};

	// check that updateSchemaCreator is an object, if not throw TypeError
	if (updateSchemaCreators && (typeof updateSchemaCreators === 'undefined' ? 'undefined' : _typeof(updateSchemaCreators)) != 'object') {
		throw new TypeError('updateSchemaCreators must be an object', 'createMastermind.js');
	} else {

		// initialize two very generic updateSchemaCreators upon creation of a mastermind

		// for generic sync updates
		updateSchemaCreators.genericStoreUpdate = genericStoreUpdate;

		// for generic async updates
		updateSchemaCreators.genericApiUpdate = genericApiUpdate;
	}

	/*** CREATE STORE ***/

	var store = void 0;
	if (options.test == true) {

		// for tests
		store = (0, _redux.createStore)((0, _redux.combineReducers)((0, _configureReducers2.default)(initialStoreState)));
	} else if (options.web || options.web == undefined) {

		// for web projects
		store = (0, _redux.createStore)((0, _redux.combineReducers)((0, _configureReducers2.default)(initialStoreState)), window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__(), (0, _redux.applyMiddleware)(_reduxLogger2.default));
	} else {

		// for mobile
		store = (0, _redux.createStore)((0, _redux.combineReducers)((0, _configureReducers2.default)(initialStoreState)), (0, _redux.applyMiddleware)(_reduxLogger2.default));
	}

	/*** CONFIGURE FIREBASE ***/

	// configure and initialize firebase if there is a config object
	var firebase = void 0;
	if (firebaseConfig) {
		firebase = (0, _configureFirebase2.default)(firebaseConfig);
		updateSchemaCreators.firebaseSignInWithEmail = firebaseSignInWithEmail;
		updateSchemaCreators.firebaseSignOut = firebaseSignOut;
		updateSchemaCreators.genericFirestoreUpdate = genericFirestoreUpdate;
	}

	// create mastermind infrastructure
	var updaterParts = (0, _createUpdaterParts2.default)({ store: store });
	var updaters = (0, _createUpdaters2.default)({ updaterParts: updaterParts, firebase: firebase });

	var listeningComponents = [];

	return {

		store: store,

		getState: store.getState,

		update: function update(updateSchemaName, updateArgs) {

			// check that user provides required name field
			if (!updateSchemaName) {
				console.log('must specify an update name');
				return;
			}

			// check that updateSchemaCreator is an object, if not throw TypeError
			if (typeof updateSchemaName != 'string') {
				throw new TypeError('updateSchemaName must be a string', 'createMastermind.js');
			}

			// check that user provides valid name
			if (!updateSchemaCreators[updateSchemaName]) {
				console.log('must provide a valid name');
				// fuzzy search possible names and give suggestion along with list of valid instructions
				return;
			}

			// create update schema
			var updateSchema = updateSchemaCreators[updateSchemaName](updateArgs);
			var type = updateSchema.type;

			// check that user provides required type field

			if (!type) {
				console.log('every updateSchema must specify a type');
				return;
			}

			// check that user provides valid processor type
			if (!updaters[type]) {
				console.log('must provide a updater');
				// fuzzy search possible type and give suggestion alongwith list of valid instructions
				return;
			}

			// log information about update
			// return new updaters[type](updateSchema)
			return new _bluebird2.default(function (resolve, reject) {
				resolve(updaters[type](updateSchema));
			}).then(function (res) {
				var branchesAffected = new Set();
				Object.keys(updateSchema).forEach(function (key) {
					if (actionGroupKeys.includes(key)) {
						var actionGroup = updateSchema[key] || {};
						Object.keys(actionGroup).forEach(function (actionName) {
							var action = actionGroup[actionName];
							branchesAffected.add(action.type);
						});
					}
				});
				listeningComponents.forEach(function (component) {
					var intersection = new Set([].concat(_toConsumableArray(branchesAffected)).filter(function (x) {
						return component.branches.has(x);
					}));
					if (intersection.size) {
						component.component.forceUpdate();
					}
				});
				return res;
			});
		},
		createDocs: function createDocs() {
			return (0, _Docs2.default)({ updateSchemasCreators: updateSchemasCreators, actionCreators: actionCreators });
		},

		addToFeed: function addToFeed(component) {
			var branches = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

			component.id = uuidv1();
			branches = new Set(branches);
			listeningComponents.push({ component: component, branches: branches });
		},

		removeFromFeed: function removeFromFeed(id) {
			listeningComponents = listeningComponents.filter(function (component) {
				return component.component.id != id;
			});
		},

		createID: uuidv1,

		branch: function branch(branchName) {
			// add check and logging for valid branch name
			return store.getState()[branchName] ? store.getState()[branchName].toJS() : undefined;
		}

	};
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVNYXN0ZXJtaW5kLmpzIl0sIm5hbWVzIjpbInV1aWR2MSIsInJlcXVpcmUiLCJnZW5lcmljU3RvcmVVcGRhdGUiLCJnZW5lcmljQXBpVXBkYXRlIiwiZmlyZWJhc2VTaWduSW5XaXRoRW1haWwiLCJmaXJlYmFzZVNpZ25PdXQiLCJnZW5lcmljRmlyZXN0b3JlVXBkYXRlIiwiYWN0aW9uR3JvdXBLZXlzIiwib3B0aW9ucyIsImluaXRpYWxTdG9yZVN0YXRlIiwidXBkYXRlU2NoZW1hQ3JlYXRvcnMiLCJmaXJlYmFzZUNvbmZpZyIsImFwcFN0YXRlIiwiT2JqZWN0IiwiYXNzaWduIiwiaXNGZXRjaGluZyIsImVycm9ycyIsIm1vZGFscyIsImF1dGgiLCJ1c2VyIiwiZGF0YSIsIlR5cGVFcnJvciIsInN0b3JlIiwidGVzdCIsIndlYiIsInVuZGVmaW5lZCIsIndpbmRvdyIsIl9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18iLCJmaXJlYmFzZSIsInVwZGF0ZXJQYXJ0cyIsInVwZGF0ZXJzIiwibGlzdGVuaW5nQ29tcG9uZW50cyIsImdldFN0YXRlIiwidXBkYXRlIiwidXBkYXRlU2NoZW1hTmFtZSIsInVwZGF0ZUFyZ3MiLCJjb25zb2xlIiwibG9nIiwidXBkYXRlU2NoZW1hIiwidHlwZSIsInJlc29sdmUiLCJyZWplY3QiLCJ0aGVuIiwicmVzIiwiYnJhbmNoZXNBZmZlY3RlZCIsIlNldCIsImtleXMiLCJmb3JFYWNoIiwia2V5IiwiaW5jbHVkZXMiLCJhY3Rpb25Hcm91cCIsImFjdGlvbk5hbWUiLCJhY3Rpb24iLCJhZGQiLCJpbnRlcnNlY3Rpb24iLCJmaWx0ZXIiLCJjb21wb25lbnQiLCJicmFuY2hlcyIsImhhcyIsIngiLCJzaXplIiwiZm9yY2VVcGRhdGUiLCJjcmVhdGVEb2NzIiwidXBkYXRlU2NoZW1hc0NyZWF0b3JzIiwiYWN0aW9uQ3JlYXRvcnMiLCJhZGRUb0ZlZWQiLCJpZCIsInB1c2giLCJyZW1vdmVGcm9tRmVlZCIs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QUQsRUFBUTtBQUN2Qm5DLHlCQUFzQkEsb0JBQW9Cd0IsTUFBcEIsQ0FBNEI7QUFBQSxXQUFhQyxVQUFVQSxTQUFWLENBQW9CVSxFQUFwQixJQUEwQkEsRUFBdkM7QUFBQSxJQUE1QixDQUF0QjtBQUNBLEdBN0VLOztBQStFTkcsWUFBVXJFLE1BL0VKOztBQWlGTnNFLFVBQVEsZ0JBQUNDLFVBQUQsRUFBd0I7QUFDL0I7QUFDQSxVQUFPakQsTUFBTVUsUUFBTixHQUFpQnVDLFVBQWpCLElBQ0pqRCxNQUFNVSxRQUFOLEdBQWlCdUMsVUFBakIsRUFBNkJDLElBQTdCLEVBREksR0FFSi9DLFNBRkg7QUFHQTs7QUF0RkssRUFBUDtBQXlGQSxDIiwiZmlsZSI6ImNyZWF0ZU1hc3Rlcm1pbmQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3JlYXRlVXBkYXRlclBhcnRzIGZyb20gJy4vY3JlYXRlVXBkYXRlclBhcnRzJ1xuaW1wb3J0IGNyZWF0ZVVwZGF0ZXJzIGZyb20gJy4vY3JlYXRlVXBkYXRlcnMnXG5pbXBvcnQgY29uZmlndXJlRmlyZWJhc2UgZnJvbSAnLi9jb25maWd1cmVGaXJlYmFzZSdcbmltcG9ydCBjb25maWd1cmVSZWR1Y2VycyBmcm9tICcuL2NvbmZpZ3VyZVJlZHVjZXJzJ1xuaW1wb3J0IERvY3MgZnJvbSAnLi9Eb2NzJ1xuaW1wb3J0IHsgYXBwbHlNaWRkbGV3YXJlLCBjb21iaW5lUmVkdWNlcnMsIGNyZWF0ZVN0b3JlIH0gZnJvbSAncmVkdXgnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ3JlZHV4LWxvZ2dlcidcbmltcG9ydCBkZWZhdWx0VXBkYXRlU2NoZW1hQ3JlYXRvcnMgZnJvbSAnLi9kZWZhdWx0VXBkYXRlU2NoZW1hQ3JlYXRvcnMnXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmNvbnN0IHV1aWR2MSA9IHJlcXVpcmUoJ3V1aWQvdjEnKVxuXG5jb25zdCB7XG5cdGdlbmVyaWNTdG9yZVVwZGF0ZSxcblx0Z2VuZXJpY0FwaVVwZGF0ZSxcblx0ZmlyZWJhc2VTaWduSW5XaXRoRW1haWwsXG5cdGZpcmViYXNlU2lnbk91dCxcblx0Z2VuZXJpY0ZpcmVzdG9yZVVwZGF0ZVxufSA9IGRlZmF1bHRVcGRhdGVTY2hlbWFDcmVhdG9yc1xuXG5cbmNvbnN0IGFjdGlvbkdyb3VwS2V5cyA9IFsnYWN0aW9ucycsICdiZWZvcmVBY3Rpb25zJywgJ3N1Y2Nlc3NBY3Rpb25zJywgJ2ZhaWx1cmVBY3Rpb25zJywgJ2FmdGVyQWN0aW9ucycgXVxuXG4vLyBUT0RPLCBhZGQgcmVkdXhDb25maWcgYXMgYW4gb3B0aW9uIHRvIHZhbGlkYXRlIGJyYW5jaGVzXG4vLyBUT0RPIHZhbGlkYXRlIG9wZXJhdGlvbnMgYWdhaW5zdCBsb2NhdGlvbnNcbmV4cG9ydCBkZWZhdWx0ICh7IG9wdGlvbnMgPSB7fSwgaW5pdGlhbFN0b3JlU3RhdGUgPSB7fSwgdXBkYXRlU2NoZW1hQ3JlYXRvcnMgPSB7fSwgZmlyZWJhc2VDb25maWcgfSkgPT4ge1xuXG5cblx0LyoqKiBJTklUSUFMSVpFIEFORCBDSEVDSyBBUkdVTUVOVFMgKioqL1xuXG5cdC8vIGluaXRpYWxpemUgb3B0aW9uc1xuXHRvcHRpb25zID0gb3B0aW9ucyB8fCB7fVxuXG5cdC8vIGluaXRpYWxpemUgaW5pdGlhbFN0b3JlU3RhdGVcblx0aW5pdGlhbFN0b3JlU3RhdGUuYXBwU3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCB7IGlzRmV0Y2hpbmc6IHt9LCBlcnJvcnM6IHt9LCBtb2RhbHM6IHt9IH0sIGluaXRpYWxTdG9yZVN0YXRlLmFwcFN0YXRlIHx8IHt9KVxuXHRpbml0aWFsU3RvcmVTdGF0ZS5hdXRoID0gT2JqZWN0LmFzc2lnbih7fSwgeyB1c2VyOiB7fSB9LCBpbml0aWFsU3RvcmVTdGF0ZS5hdXRoIHx8IHt9KVxuXHRpbml0aWFsU3RvcmVTdGF0ZS5kYXRhID0gaW5pdGlhbFN0b3JlU3RhdGUuZGF0YSB8fCB7fVxuXG5cdC8vIGNoZWNrIHRoYXQgdXBkYXRlU2NoZW1hQ3JlYXRvciBpcyBhbiBvYmplY3QsIGlmIG5vdCB0aHJvdyBUeXBlRXJyb3Jcblx0aWYgKCB1cGRhdGVTY2hlbWFDcmVhdG9ycyAmJiB0eXBlb2YgdXBkYXRlU2NoZW1hQ3JlYXRvcnMgIT0gJ29iamVjdCcgKSB7XG5cdFx0dGhyb3cgbmV3IFR5cGVFcnJvcigndXBkYXRlU2NoZW1hQ3JlYXRvcnMgbXVzdCBiZSBhbiBvYmplY3QnLCAnY3JlYXRlTWFzdGVybWluZC5qcycpXG5cdH0gZWxzZSB7XG5cblx0XHQvLyBpbml0aWFsaXplIHR3byB2ZXJ5IGdlbmVyaWMgdXBkYXRlU2NoZW1hQ3JlYXRvcnMgdXBvbiBjcmVhdGlvbiBvZiBhIG1hc3Rlcm1pbmRcblxuXHRcdC8vIGZvciBnZW5lcmljIHN5bmMgdXBkYXRlc1xuXHRcdHVwZGF0ZVNjaGVtYUNyZWF0b3JzLmdlbmVyaWNTdG9yZVVwZGF0ZSA9IGdlbmVyaWNTdG9yZVVwZGF0ZVxuXG5cdFx0Ly8gZm9yIGdlbmVyaWMgYXN5bmMgdXBkYXRlc1xuXHRcdHVwZGF0ZVNjaGVtYUNyZWF0b3JzLmdlbmVyaWNBcGlVcGRhdGUgPSBnZW5lcmljQXBpVXBkYXRlXG5cdH1cblxuXG5cdC8qKiogQ1JFQVRFIFNUT1JFICoqKi9cblxuXHRsZXQgc3RvcmVcblx0aWYgKG9wdGlvbnMudGVzdCA9PSB0cnVlKSB7XG5cblx0XHQvLyBmb3IgdGVzdHNcblx0XHRzdG9yZSA9IGNyZWF0ZVN0b3JlKGNvbWJpbmVSZWR1Y2Vycyhjb25maWd1cmVSZWR1Y2Vycyhpbml0aWFsU3RvcmVTdGF0ZSkpKVxuXG5cdH0gZWxzZSBpZiAob3B0aW9ucy53ZWIgfHwgb3B0aW9ucy53ZWIgPT0gdW5kZWZpbmVkKSB7XG5cblx0XHQvLyBmb3Igd2ViIHByb2plY3RzXG5cdFx0c3RvcmUgPSBjcmVhdGVTdG9yZShcblx0XHRcdGNvbWJpbmVSZWR1Y2Vycyhjb25maWd1cmVSZWR1Y2Vycyhpbml0aWFsU3RvcmVTdGF0ZSkpLFxuXHRcdFx0d2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18gJiYgd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18oKSxcblx0XHRcdGFwcGx5TWlkZGxld2FyZShsb2dnZXIpLFxuXHRcdClcblxuXG5cdH0gZWxzZSB7XG5cblx0XHQvLyBmb3IgbW9iaWxlXG5cdFx0c3RvcmUgPSBjcmVhdGVTdG9yZShcblx0XHRcdGNvbWJpbmVSZWR1Y2Vycyhjb25maWd1cmVSZWR1Y2Vycyhpbml0aWFsU3RvcmVTdGF0ZSkpLFxuXHRcdFx0YXBwbHlNaWRkbGV3YXJlKGxvZ2dlciksXG5cdFx0KVxuXG5cdH1cblxuXG5cdC8qKiogQ09ORklHVVJFIEZJUkVCQVNFICoqKi9cblxuXHQvLyBjb25maWd1cmUgYW5kIGluaXRpYWxpemUgZmlyZWJhc2UgaWYgdGhlcmUgaXMgYSBjb25maWcgb2JqZWN0XG5cdGxldCBmaXJlYmFzZVxuXHRpZiAoZmlyZWJhc2VDb25maWcpIHtcblx0XHRmaXJlYmFzZSA9IGNvbmZpZ3VyZUZpcmViYXNlKGZpcmViYXNlQ29uZmlnKVxuXHRcdHVwZGF0ZVNjaGVtYUNyZWF0b3JzLmZpcmViYXNlU2lnbkluV2l0aEVtYWlsID0gZmlyZWJhc2VTaWduSW5XaXRoRW1haWxcblx0XHR1cGRhdGVTY2hlbWFDcmVhdG9ycy5maXJlYmFzZVNpZ25PdXQgPSBmaXJlYmFzZVNpZ25PdXRcblx0XHR1cGRhdGVTY2hlbWFDcmVhdG9ycy5nZW5lcmljRmlyZXN0b3JlVXBkYXRlID0gZ2VuZXJpY0ZpcmVzdG9yZVVwZGF0ZVxuXHR9XG5cblx0Ly8gY3JlYXRlIG1hc3Rlcm1pbmQgaW5mcmFzdHJ1Y3R1cmVcblx0Y29uc3QgdXBkYXRlclBhcnRzID0gY3JlYXRlVXBkYXRlclBhcnRzKHsgc3RvcmUgfSlcblx0Y29uc3QgdXBkYXRlcnMgPSBjcmVhdGVVcGRhdGVycyh7IHVwZGF0ZXJQYXJ0cywgZmlyZWJhc2UgfSlcblxuXHRsZXQgbGlzdGVuaW5nQ29tcG9uZW50cyA9IFtdXG5cblx0cmV0dXJuIHtcblxuXHRcdHN0b3JlLFxuXG5cdFx0Z2V0U3RhdGU6IHN0b3JlLmdldFN0YXRlLFxuXG5cdFx0dXBkYXRlOiAodXBkYXRlU2NoZW1hTmFtZSwgdXBkYXRlQXJncykgPT4ge1xuXG5cdFx0XHQvLyBjaGVjayB0aGF0IHVzZXIgcHJvdmlkZXMgcmVxdWlyZWQgbmFtZSBmaWVsZFxuXHRcdFx0aWYgKCF1cGRhdGVTY2hlbWFOYW1lKSB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKCdtdXN0IHNwZWNpZnkgYW4gdXBkYXRlIG5hbWUnKVxuXHRcdFx0XHRyZXR1cm5cblx0XHRcdH1cblxuXHRcdFx0Ly8gY2hlY2sgdGhhdCB1cGRhdGVTY2hlbWFDcmVhdG9yIGlzIGFuIG9iamVjdCwgaWYgbm90IHRocm93IFR5cGVFcnJvclxuXHRcdFx0aWYgKCB0eXBlb2YgdXBkYXRlU2NoZW1hTmFtZSAhPSAnc3RyaW5nJyApIHtcblx0XHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcigndXBkYXRlU2NoZW1hTmFtZSBtdXN0IGJlIGEgc3RyaW5nJywgJ2NyZWF0ZU1hc3Rlcm1pbmQuanMnKVxuXHRcdFx0fVxuXG5cblx0XHRcdC8vIGNoZWNrIHRoYXQgdXNlciBwcm92aWRlcyB2YWxpZCBuYW1lXG5cdFx0XHRpZiAoIXVwZGF0ZVNjaGVtYUNyZWF0b3JzW3VwZGF0ZVNjaGVtYU5hbWVdKSB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKCdtdXN0IHByb3ZpZGUgYSB2YWxpZCBuYW1lJylcblx0XHRcdFx0Ly8gZnV6enkgc2VhcmNoIHBvc3NpYmxlIG5hbWVzIGFuZCBnaXZlIHN1Z2dlc3Rpb24gYWxvbmcgd2l0aCBsaXN0IG9mIHZhbGlkIGluc3RydWN0aW9uc1xuXHRcdFx0XHRyZXR1cm5cblx0XHRcdH1cblxuXHRcdFx0Ly8gY3JlYXRlIHVwZGF0ZSBzY2hlbWFcblx0XHRcdGNvbnN0IHVwZGF0ZVNjaGVtYSA9IHVwZGF0ZVNjaGVtYUNyZWF0b3JzW3VwZGF0ZVNjaGVtYU5hbWVdKHVwZGF0ZUFyZ3MpXG5cdFx0XHRjb25zdCB7IHR5cGUgfSA9IHVwZGF0ZVNjaGVtYVxuXG5cdFx0XHQvLyBjaGVjayB0aGF0IHVzZXIgcHJvdmlkZXMgcmVxdWlyZWQgdHlwZSBmaWVsZFxuXHRcdFx0aWYgKCF0eXBlKSB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKCdldmVyeSB1cGRhdGVTY2hlbWEgbXVzdCBzcGVjaWZ5IGEgdHlwZScpXG5cdFx0XHRcdHJldHVyblxuXHRcdFx0fVxuXG5cblx0XHRcdC8vIGNoZWNrIHRoYXQgdXNlciBwcm92aWRlcyB2YWxpZCBwcm9jZXNzb3IgdHlwZVxuXHRcdFx0aWYgKCF1cGRhdGVyc1t0eXBlXSkge1xuXHRcdFx0XHRjb25zb2xlLmxvZygnbXVzdCBwcm92aWRlIGEgdXBkYXRlcicpXG5cdFx0XHRcdC8vIGZ1enp5IHNlYXJjaCBwb3NzaWJsZSB0eXBlIGFuZCBnaXZlIHN1Z2dlc3Rpb24gYWxvbmd3aXRoIGxpc3Qgb2YgdmFsaWQgaW5zdHJ1Y3Rpb25zXG5cdFx0XHRcdHJldHVyblxuXHRcdFx0fVxuXG5cdFx0XHQvLyBsb2cgaW5mb3JtYXRpb24gYWJvdXQgdXBkYXRlXG5cdFx0XHQvLyByZXR1cm4gbmV3IHVwZGF0ZXJzW3R5cGVdKHVwZGF0ZVNjaGVtYSlcblx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSAoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRyZXNvbHZlKHVwZGF0ZXJzW3R5cGVdKHVwZGF0ZVNjaGVtYSkpXG5cdFx0XHR9KS50aGVuKChyZXMpID0+IHtcblx0XHRcdFx0bGV0IGJyYW5jaGVzQWZmZWN0ZWQgPSBuZXcgU2V0KClcblx0XHRcdFx0T2JqZWN0LmtleXModXBkYXRlU2NoZW1hKS5mb3JFYWNoKChrZXkpID0+IHtcblx0XHRcdFx0XHRpZiAoYWN0aW9uR3JvdXBLZXlzLmluY2x1ZGVzKGtleSkpIHtcblx0XHRcdFx0XHRcdGNvbnN0IGFjdGlvbkdyb3VwID0gdXBkYXRlU2NoZW1hW2tleV0gfHwge31cblx0XHRcdFx0XHRcdE9iamVjdC5rZXlzKGFjdGlvbkdyb3VwKS5mb3JFYWNoKChhY3Rpb25OYW1lKSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IGFjdGlvbiA9IGFjdGlvbkdyb3VwW2FjdGlvbk5hbWVdXG5cdFx0XHRcdFx0XHRcdGJyYW5jaGVzQWZmZWN0ZWQuYWRkKGFjdGlvbi50eXBlKVxuXHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pXG5cdFx0XHRcdGxpc3RlbmluZ0NvbXBvbmVudHMuZm9yRWFjaChjb21wb25lbnQgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGludGVyc2VjdGlvbiA9IG5ldyBTZXQoWy4uLmJyYW5jaGVzQWZmZWN0ZWRdLmZpbHRlcih4ID0+IGNvbXBvbmVudC5icmFuY2hlcy5oYXMoeCkpKVxuXHRcdFx0XHRcdGlmIChpbnRlcnNlY3Rpb24uc2l6ZSkgeyBjb21wb25lbnQuY29tcG9uZW50LmZvcmNlVXBkYXRlKCkgfVxuXHRcdFx0XHR9KVxuXHRcdFx0XHRyZXR1cm4gcmVzXG5cdFx0XHR9KVxuXHRcdH0sXG5cdFx0Y3JlYXRlRG9jczogKCkgPT4gRG9jcyh7IHVwZGF0ZVNjaGVtYXNDcmVhdG9ycywgYWN0aW9uQ3JlYXRvcnMgfSksXG5cblx0XHRhZGRUb0ZlZWQ6IChjb21wb25lbnQsIGJyYW5jaGVzID0gW10pID0+IHtcblx0XHRcdGNvbXBvbmVudC5pZCA9IHV1aWR2MSgpXG5cdFx0XHRicmFuY2hlcyA9IG5ldyBTZXQoYnJhbmNoZXMpXG5cdFx0XHRsaXN0ZW5pbmdDb21wb25lbnRzLnB1c2goeyBjb21wb25lbnQsIGJyYW5jaGVzIH0pXG5cdFx0fSxcblxuXHRcdHJlbW92ZUZyb21GZWVkOiAoaWQpID0+IHtcblx0XHRcdGxpc3RlbmluZ0NvbXBvbmVudHMgPSBsaXN0ZW5pbmdDb21wb25lbnRzLmZpbHRlciggY29tcG9uZW50ID0+IGNvbXBvbmVudC5jb21wb25lbnQuaWQgIT0gaWQgKVxuXHRcdH0sXG5cblx0XHRjcmVhdGVJRDogdXVpZHYxLFxuXG5cdFx0YnJhbmNoOiAoYnJhbmNoTmFtZTogc3RyaW5nKSA9PiB7XG5cdFx0XHQvLyBhZGQgY2hlY2sgYW5kIGxvZ2dpbmcgZm9yIHZhbGlkIGJyYW5jaCBuYW1lXG5cdFx0XHRyZXR1cm4gc3RvcmUuZ2V0U3RhdGUoKVticmFuY2hOYW1lXVxuXHRcdFx0XHQ/IHN0b3JlLmdldFN0YXRlKClbYnJhbmNoTmFtZV0udG9KUygpXG5cdFx0XHRcdDogdW5kZWZpbmVkXG5cdFx0fSxcblxuXHR9XG59XG4iXX0=